# {PROJECT_NAME} — 架构设计文档

> 本文档由开发和测试共同编写，既是代码的地图，也是测试的策略。

## 1. 架构概览

### 1.1 系统简介

{基于 PRD 简述系统的核心业务和目标用户}

### 1.2 架构风格

{单体/微服务/模块化单体/Serverless，附简要说明选择理由}

### 1.3 技术栈摘要

| 类别 | 选型 | 备注 |
|------|------|------|
| 后端语言/框架 | | |
| 前端框架 | | |
| 数据库 | | |
| 缓存 | | |
| 消息队列 | | |
| CI/CD | | |

## 2. 包结构与模块依赖

### 2.1 目录结构

```
project-root/
├── {backend/src}/
│   ├── infrastructure/          # 基础配置
│   ├── common/                  # 公共工具类、DTO
│   ├── modules/
│   │   ├── {module-a}/
│   │   │   ├── api/             # Controller / Handler 层
│   │   │   ├── core/            # 业务逻辑层（纯业务，无框架依赖）
│   │   │   └── infrastructure/  # 数据访问、外部服务等具体实现
│   │   └── {module-b}/
│   │       └── ... (相同结构)
│   └── startup/                 # 启动入口
├── {frontend}/                  # 前端项目
├── docs/
│   └── adr/                     # 架构决策记录
└── tests/
    ├── unit/                    # 单元测试
    ├── integration/             # 集成测试
    └── e2e/                     # 端到端测试
```

### 2.2 依赖规则

```
┌─────────────┐     ┌─────────────┐     ┌──────────────────┐
│   api 层     │────▶│   core 层    │◀────│ infrastructure 层 │
│ (Controller) │     │  (Service)   │     │   (Repository)    │
└─────────────┘     └─────────────┘     └──────────────────┘
```

- **core 层**：不依赖 api 层或 infrastructure 层，仅包含纯业务逻辑和领域模型
- **api 层**：依赖 core 层的接口
- **infrastructure 层**：实现 core 层定义的接口

### 2.3 模块间通信

| 源模块 | 目标模块 | 通信方式 | 说明 |
|--------|---------|---------|------|
| | | | |

## 3. 外部依赖清单

### 3.1 核心框架

| 依赖 | 版本 | 用途 |
|------|------|------|
| | | |

### 3.2 数据层

| 依赖 | 版本 | 用途 |
|------|------|------|
| | | |

### 3.3 工具库

| 依赖 | 版本 | 用途 |
|------|------|------|
| | | |

### 3.4 测试依赖

| 依赖 | 版本 | 用途 |
|------|------|------|
| | | |

### 3.5 代码质量

| 依赖 | 版本 | 用途 |
|------|------|------|
| | | |

## 4. 测试架构

### 4.1 测试金字塔

| 测试类型 | 目标层级 | 工具/技术 | 编写者 | 执行时机 |
|----------|---------|----------|--------|---------|
| 单元测试 | core 层 | | 开发 | 每次提交 |
| 集成测试 | api + infrastructure | | 开发/测试 | CI 流程 |
| 端到端测试 | 全流程 | | 测试 | 预发部署后 |

### 4.2 测试数据管理

| 测试层级 | 数据来源 | 隔离方式 |
|----------|---------|---------|
| 单元测试 | 内存对象 / Mock | 完全隔离 |
| 集成测试 | Testcontainers | 容器隔离 |
| 端到端测试 | 预置 + API 创建 | 环境隔离 |

### 4.3 覆盖率目标

| 模块 | 行覆盖率 | 分支覆盖率 |
|------|---------|----------|
| core | ≥ 80% | ≥ 70% |
| api | ≥ 60% | ≥ 50% |
| infrastructure | ≥ 50% | ≥ 40% |

## 5. 架构适应度函数

### 5.1 依赖规则检查

{描述使用什么工具（ArchUnit/dependency-cruiser/import-linter）来强制执行依赖规则}

### 5.2 编码规范检查

{描述 linter 配置}

## 6. 日志与可观测性

### 6.1 日志框架

| 配置项 | 值 | 说明 |
|--------|---|------|
| 日志框架 | | |
| 日志格式 | | JSON（生产）/ 人类可读（开发） |
| 日志语言 | English | 所有日志消息统一使用英文 |
| 关联 ID | | 请求追踪标识传播方式 |

### 6.2 日志级别规划

| 级别 | 使用场景 | 示例 |
|------|---------|------|
| ERROR | 不可恢复的错误，需要立即关注 | 外部服务不可达、数据一致性破坏 |
| WARN | 潜在问题，不影响当前操作 | 重试成功、缓存降级、接近阈值 |
| INFO | 关键业务事件和状态变化 | 请求处理完成、配置加载、启动/关闭 |
| DEBUG | 详细诊断信息（生产环境默认关闭） | 方法入参出参、中间计算结果 |

### 6.3 日志规范

- 使用参数化消息，禁止字符串拼接构建日志
- 禁止记录敏感信息（令牌、密码、密钥、PII）
- 每条日志包含：时间戳、级别、线程/协程、类名、关联 ID、消息
- 异常日志必须包含完整堆栈（仅服务端内部，不暴露给客户端）

### 6.4 结构化日志格式

```json
{
  "timestamp": "ISO-8601",
  "level": "INFO",
  "logger": "com.example.module.ClassName",
  "correlationId": "uuid",
  "message": "Processing request",
  "context": {
    "key": "value"
  }
}
```

## 7. CI/CD 流水线

### 7.1 流水线步骤

```
Checkout → 环境设置 → 依赖安装 → 单元测试 → 集成测试 → 构建 → (部署)
```

### 7.2 质量门禁

- [ ] 单元测试全部通过
- [ ] 集成测试全部通过
- [ ] 覆盖率达到阈值
- [ ] 架构规范检查通过
- [ ] 代码规范检查通过

## 附录

### A. 架构决策记录索引

| ADR 编号 | 标题 | 状态 |
|---------|------|------|
| ADR-001 | | |

### B. 术语表

| 术语 | 定义 |
|------|------|
| | |
