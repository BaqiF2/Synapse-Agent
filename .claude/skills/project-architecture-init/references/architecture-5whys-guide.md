# 架构 "5 Whys" 追问指南

本文档提供架构推导过程中 "5 Whys" 技术追问的详细参考。

## 核心原则

在需求工程中通过 "5 Whys" 找到根本原因；在架构设计中通过连续追问穿透表象，挖掘非功能性需求（质量属性）对架构的影响。

## 追问维度

### 1. 部署架构维度

| 追问层次 | 问题模板 | 目标 |
|----------|---------|------|
| Why 1 | 为什么要采用 X 架构模式？ | 识别表面驱动力 |
| Why 2 | 为什么需要 [Why 1 的答案]？ | 深入业务约束 |
| Why 3 | [Why 2 的答案] 带来了什么新问题？ | 暴露架构代价 |
| Why 4 | 为什么 [Why 3 的问题] 难以解决？ | 定位技术瓶颈 |
| Why 5 | 针对此业务场景，真的需要 [Why 4 暗示的方案] 吗？ | 做出务实决策 |

### 2. 数据架构维度

- Why 1: 为什么选择这种数据库类型？
- Why 2: 为什么需要这种一致性级别？
- Why 3: 这种一致性策略在哪些场景会失效？
- Why 4: 失效时对业务的实际影响是什么？
- Why 5: 能否用更简单的策略（如最终一致性）替代？

### 3. 通信架构维度

- Why 1: 为什么选择同步/异步通信？
- Why 2: 这种通信模式在什么条件下会成为瓶颈？
- Why 3: 瓶颈对用户体验的影响是什么？
- Why 4: 为什么不能用更简单的方案解决？
- Why 5: 实际的 SLA 要求是否真的需要这种复杂度？

### 4. 测试架构维度

- Why 1: 为什么这个模块需要集成测试而非单元测试？
- Why 2: 为什么 Mock 不能满足验证需求？
- Why 3: 集成测试的环境复杂度是否可控？
- Why 4: 测试失败时的排查成本如何？
- Why 5: 是否存在更高效的测试策略？

### 5. 可观测性维度（日志 / 监控 / 追踪）

- Why 1: 为什么需要结构化日志而非纯文本日志？
- Why 2: 当前系统的故障排查瓶颈在哪里？
- Why 3: 日志量和存储成本是否可控？
- Why 4: 是否需要分布式追踪还是关联 ID 即可满足？
- Why 5: 当前阶段是否需要完整的可观测性三支柱（日志 + 指标 + 追踪）还是日志优先？

## 追问输出物

每轮 "5 Whys" 追问完成后，应产出以下结论：

1. **包结构决策** — 模块如何划分，边界在哪里
2. **外部依赖决策** — 需要引入哪些框架/库来解决发现的问题
3. **测试策略决策** — 哪些模块需要什么级别的测试
4. **日志策略决策** — 日志级别、格式、关联 ID 方案和敏感数据处理规则
5. **ADR 记录** — 每个关键决策记录到 docs/adr/ 目录

## 场景示例库

### 场景 A: 电商系统 (Spring Boot + React)

```
Why 1: 为什么要采用微服务架构？
  → 独立部署和团队自治
Why 2: 为什么需要独立部署？
  → 订单模块变更频率远高于用户模块
Why 3: 独立部署带来了什么问题？
  → 服务间通信复杂，数据一致性难保证
Why 4: 为什么数据一致性难以保证？
  → 分布式事务需要协调
Why 5: 真的需要强一致性吗？
  → 下单扣库存用 SAGA（最终一致性），用户注册不拆分

结论：
- 包结构：按业务模块（order-service、user-service）
- 外部包：Spring Cloud（服务发现）、Kafka/RocketMQ（消息队列）
- 测试：契约测试 + 链路追踪集成验证
```

### 场景 B: 内容管理系统 (Node.js + Vue)

```
Why 1: 为什么选择前后端分离？
  → SEO 需要 SSR，同时需要丰富的交互体验
Why 2: 为什么不用全栈框架如 Nuxt？
  → 后端需要处理复杂的权限模型和工作流引擎
Why 3: 权限模型为什么复杂？
  → 多级审批流、角色继承、数据级权限
Why 4: 这些能用现成的 RBAC 库解决吗？
  → 标准 RBAC 不支持数据级权限，需定制
Why 5: 定制部分有多大？是否值得引入 ABAC？
  → 仅在文档模块需要数据级权限，其余用 RBAC 即可

结论：
- 包结构：单体应用 + 模块化（auth/、workflow/、document/）
- 外部包：casbin（灵活的 ACL 框架）
- 测试：权限模块需要大量集成测试
```

### 场景 C: 实时数据平台 (Python + React)

```
Why 1: 为什么需要实时处理？
  → 监控数据需要秒级延迟展示
Why 2: 为什么不能用定时轮询？
  → 数据量大，轮询间隔内积压严重
Why 3: 流处理框架选型的核心约束是什么？
  → 团队规模小，运维能力有限
Why 4: Kafka + Flink 的运维成本可接受吗？
  → 太重，需要更轻量的方案
Why 5: Redis Streams 或 SSE 是否满足当前规模？
  → 当前数据量 Redis Streams 完全可以，未来可迁移

结论：
- 包结构：数据管道独立为 pipeline/ 模块
- 外部包：Redis Streams + SSE（轻量级实时方案）
- 测试：pipeline 模块需要性能基准测试
```

## 追问记录模板

```markdown
## 架构追问记录

**日期：** YYYY-MM-DD
**参与者：** [团队成员]
**业务场景：** [简述]

### 追问过程

| 轮次 | 问题 | 回答 | 影响 |
|------|------|------|------|
| Why 1 | | | |
| Why 2 | | | |
| Why 3 | | | |
| Why 4 | | | |
| Why 5 | | | |

### 决策结论

- **包结构：**
- **外部依赖：**
- **测试策略：**
- **需记录的 ADR：**
```
