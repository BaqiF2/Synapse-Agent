# Synapse Agent ä»£ç åº“é‡æ„è®¡åˆ’

> ç»¼åˆä¸šåŠ¡åˆ†æã€ä»£ç æ¶æ„åˆ†æã€AI Agent æœ€ä½³å®è·µå¯¹æ ‡ä¸‰ä»½æŠ¥å‘Šåˆ¶å®š
> åˆ¶å®šæ—¥æœŸï¼š2026-02-20

---

## ä¸€ã€é‡æ„ç›®æ ‡

### 1.1 è´¨é‡ç›®æ ‡

| æŒ‡æ ‡ | å½“å‰å€¼ | ç›®æ ‡å€¼ |
|------|--------|--------|
| æœ€å¤§æ–‡ä»¶è¡Œæ•° | 895 è¡Œ | â‰¤ 300 è¡Œ |
| å¾ªç¯ä¾èµ–æ•° | 1+ | 0 |
| å•æ–‡ä»¶èŒè´£æ•° | æœ€å¤š 5 ç§ | 1 ç§ |
| `any` ä½¿ç”¨æ•° | 4 | 0 |
| å•å…ƒæµ‹è¯•è¦†ç›–ç‡ | æœªçŸ¥ | â‰¥ 80% |
| æŠ€èƒ½è‡ªåŠ¨ç”Ÿæˆæœ‰æ•ˆç‡ | ~70% | â‰¥ 90% |
| æŠ€èƒ½å¤ç”¨ç‡ | ~60% | â‰¥ 80% |

### 1.2 æ¶æ„ç›®æ ‡

- **æ¨¡å—åŒ–**ï¼šæ¯ä¸ªæ¨¡å—èŒè´£å•ä¸€ã€è¾¹ç•Œæ¸…æ™°ã€å¯ç‹¬ç«‹æµ‹è¯•
- **å¯æ‰©å±•**ï¼šæ–°å·¥å…·/æ–°èƒ½åŠ›æ¥å…¥æˆæœ¬ä½ï¼Œæ”¯æŒæ’ä»¶å¼æ‰©å±•
- **å¯è§‚æµ‹**ï¼šå…³é”®è·¯å¾„æœ‰å®Œæ•´çš„äº‹ä»¶è¿½è¸ªå’ŒæŒ‡æ ‡ç›‘æ§
- **å¯é æ€§**ï¼šç»Ÿä¸€çš„é”™è¯¯å¤„ç†ä½“ç³»ï¼Œå®Œå–„çš„æ¢å¤æœºåˆ¶

### 1.3 æ ¸å¿ƒç‰¹è‰²ä¿ç•™ï¼ˆä¸å¯å¦¥åï¼‰

ä»¥ä¸‹æ˜¯ Synapse Agent çš„æ ¸å¿ƒå·®å¼‚åŒ–èƒ½åŠ›ï¼Œé‡æ„è¿‡ç¨‹ä¸­å¿…é¡»ä¿ç•™å’Œå¼ºåŒ–ï¼š

1. **ä¸‰å±‚å·¥å…·ç»Ÿä¸€æŠ½è±¡**ï¼ˆNative/Agent/Extension Shell Commandï¼‰
2. **å•ä¸€ Bash å·¥å…·å…¥å£** â€” LLM åªéœ€å­¦ä¹ ä¸€ä¸ªå·¥å…·
3. **è‡ªæˆ‘æˆé•¿æœºåˆ¶** â€” ä»ä»»åŠ¡ä¸­è‡ªåŠ¨ç”Ÿæˆå’Œå¼ºåŒ–æŠ€èƒ½
4. **æŠ€èƒ½ç³»ç»Ÿ** â€” æ–‡ä»¶ç³»ç»Ÿ + å·¥å…·çš„çŸ¥è¯†ç®¡ç†
5. **ä¸Šä¸‹æ–‡æ™ºèƒ½ç®¡ç†** â€” offload/compact æœºåˆ¶
6. **Provider æŠ½è±¡** â€” å¹²å‡€çš„ LLM æä¾›è€…æ¥å£

---

## äºŒã€é—®é¢˜å…¨æ™¯

### 2.1 ä¸‰ä»½æŠ¥å‘Šäº¤å‰éªŒè¯çš„æ ¸å¿ƒé—®é¢˜

| # | é—®é¢˜ | ä¸šåŠ¡å½±å“ | ä»£ç å½±å“ | æ¶æ„å½±å“ | ä¼˜å…ˆçº§ |
|---|------|---------|---------|---------|--------|
| 1 | å¤§æ–‡ä»¶ / God Object | - | TerminalRenderer 895è¡Œã€SkillManager 616è¡Œç­‰ 6 ä¸ªæ–‡ä»¶è¶… 500 è¡Œ | å¯ç»´æŠ¤æ€§å·® | **P0** |
| 2 | å¾ªç¯ä¾èµ– | - | skill-manager â†” skill-command-handler â†” sub-agent-manager | åˆå§‹åŒ–é£é™© | **P0** |
| 3 | Agent ä¸»å¾ªç¯å¤æ‚ | - | executeLoop() 3å±‚åµŒå¥— | å¯æµ‹è¯•æ€§å·® | **P0** |
| 4 | æŠ€èƒ½ç”Ÿæˆè´¨é‡ä¸ç¨³å®š | ~30% ç¼ºé™·ç‡ | å…ƒæŠ€èƒ½ prompt + ç¼ºå°‘éªŒè¯ | å‰Šå¼±æ ¸å¿ƒç†å¿µ | **P0** |
| 5 | æŠ€èƒ½å¤ç”¨ç‡ä½ | 40% æœªå‘½ä¸­ | æœç´¢ Agent prompt éœ€ä¼˜åŒ– | ç†å¿µéªŒè¯ä¸è¶³ | **P1** |
| 6 | å¤–æºæŠ€èƒ½èåˆè–„å¼± | åœºæ™¯ä¸‰éªŒè¯å¤±è´¥ | SkillMerger è¿‡äºç®€å• | æˆé•¿èƒ½åŠ›å—é™ | **P1** |
| 7 | é”™è¯¯å¤„ç†ä¸ç»Ÿä¸€ | - | æ··åˆ throw / return æ¨¡å¼ | å¯é æ€§å·® | **P1** |
| 8 | å·¥å…·è·¯ç”±å¤æ‚åº¦é«˜ | - | æ¡ä»¶åˆ†æ”¯åˆ†æ•£ | æ‰©å±•æˆæœ¬é«˜ | **P1** |
| 9 | ç¼ºä¹å¯è§‚æµ‹æ€§ | - | ä»…åŸºç¡€æ—¥å¿— | æ’éšœå›°éš¾ | **P2** |
| 10 | å·¥ä½œæµç¼–æ’èƒ½åŠ›å¼± | - | SubAgent æ‰‹åŠ¨ç¼–æ’ | å¤æ‚ä»»åŠ¡å—é™ | **P2** |

### 2.2 ä»£ç çƒ­ç‚¹åœ°å›¾ï¼ˆéœ€é‡æ„çš„æ–‡ä»¶ï¼‰

```
src/
â”œâ”€â”€ cli/
â”‚   â”œâ”€â”€ terminal-renderer.ts    [895è¡Œ] ğŸ”´ P0 - God Objectï¼Œ5ç§èŒè´£æ··åˆ
â”‚   â””â”€â”€ repl-commands.ts        [594è¡Œ] ğŸŸ¡ P1 - å‘½ä»¤å¤„ç†è¿‡åº¦èšåˆ
â”œâ”€â”€ agent/
â”‚   â”œâ”€â”€ agent-runner.ts         [583è¡Œ] ğŸ”´ P0 - ä¸»å¾ªç¯å¤æ‚åº¦é«˜
â”‚   â””â”€â”€ session.ts              [581è¡Œ] ğŸŸ¡ P1 - å¯æ‹†åˆ†ä¼šè¯ç®¡ç†
â”œâ”€â”€ skills/
â”‚   â”œâ”€â”€ skill-manager.ts        [616è¡Œ] ğŸ”´ P0 - å¾ªç¯ä¾èµ–æ ¸å¿ƒ
â”‚   â”œâ”€â”€ skill-enhancer.ts       [522è¡Œ] ğŸŸ¡ P1 - å¼ºåŒ–é€»è¾‘å¯ä¼˜åŒ–
â”‚   â”œâ”€â”€ skill-schema.ts         [512è¡Œ] ğŸŸ¢ P2 - æ•°æ®å®šä¹‰ï¼Œå½±å“å°
â”‚   â””â”€â”€ skill-loader.ts         [455è¡Œ] ğŸŸ¢ P2 - åŠ è½½é€»è¾‘å¯ä¼˜åŒ–
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ handlers/
â”‚   â”‚   â””â”€â”€ skill-command-handler.ts [557è¡Œ] ğŸ”´ P0 - å¾ªç¯ä¾èµ–å‚ä¸è€…
â”‚   â”œâ”€â”€ converters/
â”‚   â”‚   â”œâ”€â”€ skill/watcher.ts    [592è¡Œ] ğŸŸ¡ P1 - ç›‘å¬é€»è¾‘è¿‡é‡
â”‚   â”‚   â”œâ”€â”€ skill/skill-structure.ts [516è¡Œ] ğŸŸ¢ P2
â”‚   â”‚   â”œâ”€â”€ skill/docstring-parser.ts [468è¡Œ] ğŸŸ¢ P2
â”‚   â”‚   â””â”€â”€ mcp/mcp-client.ts   [453è¡Œ] ğŸŸ¢ P2
â”‚   â””â”€â”€ bash-router.ts          ğŸŸ¡ P1 - è·¯ç”±é€»è¾‘å¯ä¼˜åŒ–
â””â”€â”€ providers/
    â””â”€â”€ anthropic/anthropic-client.ts [543è¡Œ] ğŸŸ¢ P2 - Provider å®ç°
```

---

## ä¸‰ã€åˆ†é˜¶æ®µé‡æ„è®¡åˆ’

### Phase 1ï¼šæ¶æ„ç¨³å®šæ€§ï¼ˆåŸºç¡€æ¸…ç†ï¼‰

> ç›®æ ‡ï¼šæ¶ˆé™¤æ¶æ„é£é™©ï¼Œå»ºç«‹é‡æ„å®‰å…¨ç½‘
> é¢„æœŸï¼šä»£ç å¯ç»´æŠ¤æ€§æ˜¾è‘—æå‡ï¼Œä¸ºåç»­é‡æ„å¥ å®šåŸºç¡€

#### 1.1 å»ºç«‹æµ‹è¯•å®‰å…¨ç½‘

åœ¨ä»»ä½•é‡æ„ä¹‹å‰ï¼Œå…ˆä¸ºæ ¸å¿ƒæ¨¡å—è¡¥å……æµ‹è¯•ï¼š

- [ ] AgentRunner æ ¸å¿ƒå¾ªç¯çš„é›†æˆæµ‹è¯•
- [ ] BashRouter è·¯ç”±é€»è¾‘çš„å•å…ƒæµ‹è¯•
- [ ] SkillManager ç”Ÿå‘½å‘¨æœŸçš„å•å…ƒæµ‹è¯•
- [ ] TerminalRenderer å…³é”®æ¸²æŸ“è·¯å¾„çš„å¿«ç…§æµ‹è¯•

#### 1.2 è§£å†³å¾ªç¯ä¾èµ–ï¼ˆP0ï¼‰

**é—®é¢˜**ï¼šskill-manager â†’ skill-enhancer â†’ SubAgentManager â†’ skill-command-handler â†’ skill-manager

**æ–¹æ¡ˆ**ï¼šæå– `SkillMetadataService` æ‰“ç ´å¾ªç¯

```
é‡æ„å‰ï¼š
skill-manager.ts â†â†’ skill-command-handler.tsï¼ˆé€šè¿‡ skill-enhancer / sub-agent-manager é—´æ¥å¾ªç¯ï¼‰

é‡æ„åï¼š
skill-metadata-service.tsï¼ˆæ–°ï¼‰â† skill-manager.ts
                              â† skill-command-handler.ts
                              â† skill-enhancer.ts
ï¼ˆä¸‰è€…éƒ½ä¾èµ– metadata serviceï¼Œä¸å†ç›¸äº’ä¾èµ–ï¼‰
```

å…·ä½“æ­¥éª¤ï¼š
1. ä» `skill-manager.ts` æå–å…ƒæ•°æ®ç›¸å…³æ¥å£ï¼ˆæŸ¥è¯¢ã€ç´¢å¼•ã€æœç´¢ï¼‰åˆ° `SkillMetadataService`
2. `skill-command-handler` ä¾èµ– `SkillMetadataService` è€Œé `SkillManager`
3. `skill-enhancer` é€šè¿‡å›è°ƒ/äº‹ä»¶è€Œéç›´æ¥å¼•ç”¨ä¸ `SkillManager` äº¤äº’
4. éªŒè¯æ— å¾ªç¯ä¾èµ–ï¼ˆå¯ç”¨ `madge` å·¥å…·æ£€æµ‹ï¼‰

#### 1.3 åˆ†è§£ TerminalRendererï¼ˆP0ï¼‰

**é—®é¢˜**ï¼š895 è¡Œï¼Œæ··åˆ 5 ç§èŒè´£

**æ–¹æ¡ˆ**ï¼šæŒ‰èŒè´£æ‹†åˆ†ä¸º 5 ä¸ªæ¨¡å—

```
é‡æ„å‰ï¼š
terminal-renderer.ts (895è¡Œï¼Œ5ç§èŒè´£)

é‡æ„åï¼š
cli/renderer/
â”œâ”€â”€ terminal-renderer.ts      # ä¸»æ¸²æŸ“å™¨ï¼Œç»„åˆå„å­æ¨¡å—ï¼ˆâ‰¤200è¡Œï¼‰
â”œâ”€â”€ tool-call-renderer.ts     # å·¥å…·è°ƒç”¨æ¸²æŸ“ï¼ˆçŠ¶æ€å±•ç¤ºã€ç»“æœæ ¼å¼åŒ–ï¼‰
â”œâ”€â”€ sub-agent-renderer.ts     # SubAgent çŠ¶æ€æ¸²æŸ“
â”œâ”€â”€ animation-controller.ts   # åŠ è½½åŠ¨ç”»ç®¡ç†ï¼ˆspinnerã€è¿›åº¦ï¼‰
â””â”€â”€ render-tree-builder.ts    # æ ‘ç»“æ„æ„å»ºï¼ˆè¾“å‡ºç»„ç»‡ï¼‰
```

å…³é”®åŸåˆ™ï¼š
- `TerminalRenderer` ä¿ç•™ä¸ºå¤–éƒ¨æ¥å£ï¼ˆFacade æ¨¡å¼ï¼‰ï¼Œå†…éƒ¨å§”æ‰˜ç»™å­æ¨¡å—
- å„å­æ¨¡å—é€šè¿‡æ¥å£é€šä¿¡ï¼Œä¸ç›´æ¥äº’ç›¸å¼•ç”¨
- åŠ¨ç”»æ§åˆ¶å™¨ç®¡ç†æ‰€æœ‰ `setInterval` ç”Ÿå‘½å‘¨æœŸ

#### 1.4 ç®€åŒ– Agent ä¸»å¾ªç¯ï¼ˆP0ï¼‰

**é—®é¢˜**ï¼š`executeLoop()` åŒ…å« 3 å±‚åµŒå¥—ï¼Œæ··åˆå·¥å…·ç¼–æ’å’Œé”™è¯¯å¤„ç†

**æ–¹æ¡ˆ**ï¼šæå–å­å‡½æ•°ï¼Œæ‰å¹³åŒ–æ§åˆ¶æµ

```typescript
// é‡æ„å‰ï¼šexecuteLoop() ä¸€ä¸ªå¤§å‡½æ•°å¤„ç†æ‰€æœ‰é€»è¾‘

// é‡æ„åï¼š
class AgentRunner {
  async executeLoop(): Promise<void> {
    // é¡¶å±‚å¾ªç¯ï¼Œæ¸…æ™°çš„æ­¥éª¤
    while (this.shouldContinue()) {
      const response = await this.generateResponse();
      const toolCalls = this.extractToolCalls(response);

      if (toolCalls.length === 0) break;

      const results = await this.executeToolCalls(toolCalls);
      this.updateHistory(results);
    }
  }

  // æå–çš„å­å‡½æ•°
  private async executeToolCalls(calls: ToolCall[]): Promise<ToolResult[]> { ... }
  private handleToolFailure(result: ToolResult): FailureAction { ... }
  private shouldContinue(): boolean { ... }
}
```

#### 1.5 ç»Ÿä¸€é”™è¯¯å¤„ç†ä½“ç³»ï¼ˆP1ï¼‰

**é—®é¢˜**ï¼šæ··åˆä½¿ç”¨ `throw new Error()` å’Œ `return errorResult()`

**æ–¹æ¡ˆ**ï¼šå»ºç«‹åˆ†å±‚é”™è¯¯ä½“ç³»

```typescript
// src/common/errors.ts
abstract class SynapseError extends Error {
  abstract readonly code: string;
  abstract readonly recoverable: boolean;
}

class ToolExecutionError extends SynapseError { ... }
class CommandNotFoundError extends SynapseError { ... }
class SkillValidationError extends SynapseError { ... }
class ProviderError extends SynapseError { ... }

// å·¥å…·å±‚ï¼šå§‹ç»ˆè¿”å› Result ç±»å‹
type ToolResult = { success: true; output: string } | { success: false; error: SynapseError }

// Agent å±‚ï¼šæ•è·å¹¶åˆ†ç±»å¤„ç†
// Provider å±‚ï¼šåŒ…è£…åŸå§‹ SDK å¼‚å¸¸
```

---

### Phase 2ï¼šæ ¸å¿ƒæ¨¡å—é‡æ„

> ç›®æ ‡ï¼šæå‡æ ¸å¿ƒæ¨¡å—çš„ä»£ç è´¨é‡å’Œå¯æ‰©å±•æ€§
> å‰ç½®æ¡ä»¶ï¼šPhase 1 çš„æµ‹è¯•å®‰å…¨ç½‘å’Œå¾ªç¯ä¾èµ–å·²è§£å†³

#### 2.1 å·¥å…·è·¯ç”±ç³»ç»Ÿä¼˜åŒ–ï¼ˆP1ï¼‰

**é—®é¢˜**ï¼šBashRouter ä¸­è·¯ç”±è§„åˆ™åˆ†æ•£ï¼Œæ¡ä»¶åˆ¤æ–­å¤æ‚

**æ–¹æ¡ˆ**ï¼šå¼•å…¥ä¼˜å…ˆçº§è·¯ç”±è¡¨æ›¿ä»£é€ä¸€åŒ¹é…

```typescript
// é‡æ„å‰ï¼šif/else é“¾å¼åŒ¹é…
// é‡æ„åï¼šå£°æ˜å¼è·¯ç”±è¡¨

interface RouteRule {
  pattern: string | RegExp;   // åŒ¹é…æ¨¡å¼
  priority: number;           // ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå°è¶Šä¼˜å…ˆï¼‰
  handler: string;            // handler æ³¨å†Œå
  classify?: (cmd: string) => boolean;  // å¯é€‰çš„è‡ªå®šä¹‰åˆ†ç±»å™¨
}

class BashRouter {
  private routes: RouteRule[] = [
    { pattern: 'skill-tool:', priority: 10, handler: 'skill-tool:', classify: isSkillToolCommand },
    { pattern: 'skill:',      priority: 20, handler: 'skill:' },
    { pattern: 'mcp:',        priority: 30, handler: 'mcp:' },
    { pattern: 'task:',       priority: 40, handler: 'task:' },
    // ... å…¶ä»–è·¯ç”±
  ];

  findHandler(command: string): Handler {
    const sorted = this.routes.sort((a, b) => a.priority - b.priority);
    for (const route of sorted) {
      if (this.matches(command, route)) {
        return this.handlerRegistry.get(route.handler);
      }
    }
    return this.nativeShellHandler;
  }
}
```

#### 2.2 SkillManager èŒè´£æ‹†åˆ†ï¼ˆP0/P1ï¼‰

**é—®é¢˜**ï¼š616 è¡Œï¼Œæ‰¿æ‹…ç‰ˆæœ¬ç®¡ç†ã€å¯¼å…¥å¯¼å‡ºã€ç´¢å¼•æœç´¢ç­‰å¤šç§èŒè´£

**æ–¹æ¡ˆ**ï¼šæ‹†åˆ†ä¸ºèŒè´£å•ä¸€çš„å­æ¨¡å—

```
é‡æ„å‰ï¼š
skill-manager.ts (616è¡Œï¼Œæ‰€æœ‰æŠ€èƒ½ç®¡ç†é€»è¾‘)

é‡æ„åï¼š
skills/
â”œâ”€â”€ skill-manager.ts           # Facadeï¼Œç»„åˆå­æ¨¡å—ï¼ˆâ‰¤150è¡Œï¼‰
â”œâ”€â”€ skill-metadata-service.ts  # å…ƒæ•°æ®æŸ¥è¯¢ã€ç´¢å¼•ã€æœç´¢
â”œâ”€â”€ skill-version-manager.ts   # ç‰ˆæœ¬ç®¡ç†ã€å›æ»š
â”œâ”€â”€ skill-import-export.ts     # æŠ€èƒ½å¯¼å…¥/å¯¼å‡º
â””â”€â”€ skill-validator.ts         # æŠ€èƒ½æ ¼å¼éªŒè¯ï¼ˆæ–°å¢ï¼‰
```

#### 2.3 CLI æ¨¡å—è§£è€¦ï¼ˆP1ï¼‰

**é—®é¢˜**ï¼šrepl-commands.ts 594 è¡Œï¼Œå‘½ä»¤å¤„ç†è¿‡åº¦èšåˆ

**æ–¹æ¡ˆ**ï¼šæŒ‰å‘½ä»¤ç±»å‹æ‹†åˆ†

```
é‡æ„å‰ï¼š
repl-commands.ts (594è¡Œï¼Œæ‰€æœ‰ REPL å‘½ä»¤)

é‡æ„åï¼š
cli/commands/
â”œâ”€â”€ index.ts                  # å‘½ä»¤æ³¨å†Œè¡¨
â”œâ”€â”€ session-commands.ts       # /save, /load, /clear ç­‰ä¼šè¯å‘½ä»¤
â”œâ”€â”€ skill-commands.ts         # /skill ç›¸å…³å‘½ä»¤
â”œâ”€â”€ config-commands.ts        # /config, /model ç­‰é…ç½®å‘½ä»¤
â”œâ”€â”€ debug-commands.ts         # /debug, /log ç­‰è°ƒè¯•å‘½ä»¤
â””â”€â”€ help-commands.ts          # /help, /version ç­‰ä¿¡æ¯å‘½ä»¤
```

#### 2.4 Session æ¨¡å—ä¼˜åŒ–ï¼ˆP1ï¼‰

**é—®é¢˜**ï¼šsession.ts 581 è¡Œï¼Œä¼šè¯ç®¡ç†å’ŒæŒä¹…åŒ–æ··åˆ

**æ–¹æ¡ˆ**ï¼šåˆ†ç¦»ä¼šè¯çŠ¶æ€å’ŒæŒä¹…åŒ–é€»è¾‘

```
é‡æ„åï¼š
agent/
â”œâ”€â”€ session.ts                # ä¼šè¯çŠ¶æ€ç®¡ç†ï¼ˆâ‰¤200è¡Œï¼‰
â”œâ”€â”€ session-persistence.ts    # ä¼šè¯æŒä¹…åŒ–ï¼ˆä¿å­˜/åŠ è½½/åºåˆ—åŒ–ï¼‰
â””â”€â”€ session-context.ts        # ä¸Šä¸‹æ–‡çª—å£ç®¡ç†ï¼ˆoffload/compact åè°ƒï¼‰
```

---

### Phase 3ï¼šåŠŸèƒ½å¼ºåŒ–

> ç›®æ ‡ï¼šå¼ºåŒ–æ ¸å¿ƒç‰¹è‰²åŠŸèƒ½ï¼Œæå‡ Agent çš„å®é™…èƒ½åŠ›
> å‰ç½®æ¡ä»¶ï¼šPhase 1-2 çš„æ¶æ„æ¸…ç†å·²å®Œæˆ

#### 3.1 æŠ€èƒ½ç”Ÿæˆè´¨é‡æå‡ï¼ˆP0 ä¸šåŠ¡ä¼˜å…ˆï¼‰

**é—®é¢˜**ï¼šçº¦ 30% çš„è‡ªåŠ¨ç”ŸæˆæŠ€èƒ½éœ€äººå·¥ä¿®å¤

**æ–¹æ¡ˆ**ï¼š

1. **ä¼˜åŒ–å…ƒæŠ€èƒ½ Prompt**
   - å¢åŠ  few-shot ç¤ºä¾‹ï¼ˆæˆåŠŸçš„æŠ€èƒ½æ¨¡æ¿ï¼‰
   - æ˜ç¡®è¾“å‡ºæ ¼å¼çº¦æŸï¼ˆSKILL.md è§„èŒƒæ ¡éªŒï¼‰
   - æ·»åŠ  chain-of-thought å¼•å¯¼

2. **æ·»åŠ æŠ€èƒ½éªŒè¯å±‚**ï¼ˆæ–°æ¨¡å— `skill-validator.ts`ï¼‰
   ```typescript
   class SkillValidator {
     // ç»“æ„éªŒè¯ï¼šSKILL.md æ ¼å¼ã€å¿…å¡«å­—æ®µ
     validateStructure(skill: Skill): ValidationResult;
     // è¯­ä¹‰éªŒè¯ï¼šé€šè¿‡ LLM æ£€æŸ¥æŠ€èƒ½æè¿°ä¸å®ç°çš„ä¸€è‡´æ€§
     validateSemantics(skill: Skill): Promise<ValidationResult>;
     // å¯æ‰§è¡Œæ€§éªŒè¯ï¼šdry-run æ£€æŸ¥å·¥å…·å¼•ç”¨æ˜¯å¦æœ‰æ•ˆ
     validateExecutability(skill: Skill): Promise<ValidationResult>;
   }
   ```

3. **åé¦ˆå¾ªç¯**
   - ç”Ÿæˆåè‡ªåŠ¨éªŒè¯ â†’ éªŒè¯å¤±è´¥è‡ªåŠ¨ä¿®å¤ï¼ˆæœ€å¤š 2 è½®ï¼‰
   - è®°å½•ç”ŸæˆæˆåŠŸ/å¤±è´¥ç»Ÿè®¡ï¼Œç”¨äºæŒç»­ä¼˜åŒ– prompt

#### 3.2 æŠ€èƒ½æœç´¢ä¸å¤ç”¨ä¼˜åŒ–ï¼ˆP1ï¼‰

**é—®é¢˜**ï¼šæŠ€èƒ½å¤ç”¨ç‡ ~60%ï¼Œæœç´¢ Agent åŒ¹é…ä¸ç²¾å‡†

**æ–¹æ¡ˆ**ï¼š

1. **ä¼˜åŒ–æœç´¢ Prompt**
   - å¢åŠ ä»»åŠ¡-æŠ€èƒ½åŒ¹é…çš„ few-shot ç¤ºä¾‹
   - æ·»åŠ å¦å®šç¤ºä¾‹ï¼ˆé¿å…é”™è¯¯åŒ¹é…ï¼‰

2. **æŠ€èƒ½ç´¢å¼•å¢å¼º**
   - ä¸ºæ¯ä¸ªæŠ€èƒ½ç”Ÿæˆå…³é”®è¯æ ‡ç­¾å’Œé€‚ç”¨åœºæ™¯æè¿°
   - æ”¯æŒåŸºäºæ ‡ç­¾çš„å¿«é€Ÿç­›é€‰ + LLM ç²¾æ’

3. **å¤ç”¨åé¦ˆæœºåˆ¶**
   - è®°å½•æŠ€èƒ½ä½¿ç”¨æˆåŠŸ/å¤±è´¥ï¼Œè°ƒæ•´æœç´¢æƒé‡

#### 3.3 å¤–æºæŠ€èƒ½èåˆå¼ºåŒ–ï¼ˆP1ï¼‰

**é—®é¢˜**ï¼šSkillMerger é€»è¾‘è¿‡äºç®€å•ï¼Œåœºæ™¯ä¸‰éªŒè¯å¤±è´¥

**æ–¹æ¡ˆ**ï¼š

1. **LLM é©±åŠ¨çš„å†²çªè§£å†³**
   ```typescript
   class SmartSkillMerger {
     // åˆ†æå¤–æºæŠ€èƒ½ä¸å·²æœ‰æŠ€èƒ½çš„å…³ç³»
     analyzeRelationship(external: Skill, existing: Skill[]): MergeAnalysis;
     // LLM é©±åŠ¨çš„æ™ºèƒ½åˆå¹¶
     mergeWithLLM(analysis: MergeAnalysis): Promise<MergedSkill>;
     // åˆå¹¶åéªŒè¯
     validateMerge(merged: MergedSkill): Promise<ValidationResult>;
   }
   ```

2. **èåˆç­–ç•¥**
   - è¡¥å……ï¼šå¤–æºæŠ€èƒ½å¡«è¡¥å·²æœ‰æŠ€èƒ½åº“çš„ç©ºç™½
   - å¼ºåŒ–ï¼šå¤–æºæŠ€èƒ½çš„ä¼˜åŒ–æ–¹æ¡ˆåº”ç”¨åˆ°å·²æœ‰æŠ€èƒ½
   - æ›¿æ¢ï¼šå¤–æºæŠ€èƒ½æ˜æ˜¾ä¼˜äºå·²æœ‰æŠ€èƒ½æ—¶æ›¿æ¢

#### 3.4 å¯è§‚æµ‹æ€§å¢å¼ºï¼ˆP2ï¼‰

**æ–¹æ¡ˆ**ï¼šå»ºç«‹äº‹ä»¶é©±åŠ¨çš„è§‚æµ‹ä½“ç³»

```typescript
// ç»Ÿä¸€äº‹ä»¶æ€»çº¿
class AgentEventBus {
  emit(event: AgentEvent): void;
  on(type: EventType, handler: EventHandler): void;
}

// äº‹ä»¶ç±»å‹
type AgentEvent =
  | { type: 'tool_call_start'; tool: string; args: unknown }
  | { type: 'tool_call_end'; tool: string; duration: number; success: boolean }
  | { type: 'llm_call_start'; model: string; tokens_estimate: number }
  | { type: 'llm_call_end'; model: string; tokens_used: TokenUsage; cost: number }
  | { type: 'skill_loaded'; skill: string }
  | { type: 'skill_generated'; skill: string; quality: number }
  | { type: 'error'; error: SynapseError };

// æ¶ˆè´¹è€…
class MetricsCollector implements EventConsumer { ... }  // æŒ‡æ ‡æ”¶é›†
class CostTracker implements EventConsumer { ... }       // æˆæœ¬è·Ÿè¸ª
class DebugTracer implements EventConsumer { ... }       // è°ƒè¯•è¿½è¸ª
```

---

## å››ã€é‡æ„ä¼˜å…ˆçº§æ€»è§ˆ

```
Phase 1ï¼ˆæ¶æ„ç¨³å®šæ€§ï¼‰
 â”œâ”€ 1.1 å»ºç«‹æµ‹è¯•å®‰å…¨ç½‘                      [å‰ç½®æ¡ä»¶]
 â”œâ”€ 1.2 è§£å†³å¾ªç¯ä¾èµ–                        [P0]
 â”œâ”€ 1.3 åˆ†è§£ TerminalRenderer               [P0]
 â”œâ”€ 1.4 ç®€åŒ– Agent ä¸»å¾ªç¯                   [P0]
 â””â”€ 1.5 ç»Ÿä¸€é”™è¯¯å¤„ç†ä½“ç³»                    [P1]

Phase 2ï¼ˆæ ¸å¿ƒæ¨¡å—é‡æ„ï¼‰
 â”œâ”€ 2.1 å·¥å…·è·¯ç”±ç³»ç»Ÿä¼˜åŒ–                    [P1]
 â”œâ”€ 2.2 SkillManager èŒè´£æ‹†åˆ†               [P0â†’P1]
 â”œâ”€ 2.3 CLI æ¨¡å—è§£è€¦                        [P1]
 â””â”€ 2.4 Session æ¨¡å—ä¼˜åŒ–                    [P1]

Phase 3ï¼ˆåŠŸèƒ½å¼ºåŒ–ï¼‰
 â”œâ”€ 3.1 æŠ€èƒ½ç”Ÿæˆè´¨é‡æå‡                    [P0 ä¸šåŠ¡]
 â”œâ”€ 3.2 æŠ€èƒ½æœç´¢ä¸å¤ç”¨ä¼˜åŒ–                  [P1]
 â”œâ”€ 3.3 å¤–æºæŠ€èƒ½èåˆå¼ºåŒ–                    [P1]
 â””â”€ 3.4 å¯è§‚æµ‹æ€§å¢å¼º                        [P2]
```

---

## äº”ã€é£é™©è¯„ä¼°ä¸ç¼“è§£

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| é‡æ„å¼•å…¥å›å½’ Bug | é«˜ | ä¸­ | Phase 1 å…ˆå»ºæµ‹è¯•å®‰å…¨ç½‘ï¼›æ¯æ¬¡é‡æ„åè¿è¡Œå…¨é‡æµ‹è¯• |
| å¾ªç¯ä¾èµ–ä¿®å¤å½±å“åˆå§‹åŒ–é¡ºåº | é«˜ | ä½ | ä½¿ç”¨ `madge` æŒç»­æ£€æµ‹ï¼›å¢åŠ å¯åŠ¨é›†æˆæµ‹è¯• |
| TerminalRenderer æ‹†åˆ†å½±å“ UI ä¸€è‡´æ€§ | ä¸­ | ä¸­ | å¿«ç…§æµ‹è¯•ä¿è¯æ¸²æŸ“è¾“å‡ºä¸å˜ |
| æŠ€èƒ½ç³»ç»Ÿé‡æ„å½±å“å·²æœ‰æŠ€èƒ½ | ä¸­ | ä½ | å‘åå…¼å®¹çš„ SKILL.md æ ¼å¼ï¼›è¿ç§»è„šæœ¬ |
| é‡æ„èŒƒå›´è†¨èƒ€ | é«˜ | é«˜ | ä¸¥æ ¼æŒ‰ Phase æ¨è¿›ï¼›æ¯ä¸ª Phase ç‹¬ç«‹éªŒæ”¶ |
| å¹¶è¡Œå¼€å‘å†²çª | ä¸­ | ä¸­ | æŒ‰æ¨¡å—åˆ†é…ï¼Œå‡å°‘äº¤å‰ä¿®æ”¹ |

---

## å…­ã€æµ‹è¯•ç­–ç•¥

### 6.1 é‡æ„æœŸé—´çš„æµ‹è¯•åŸåˆ™

1. **å…ˆå†™æµ‹è¯•ï¼Œå†é‡æ„**ï¼šæ¯ä¸ªé‡æ„é¡¹å¯åŠ¨å‰ï¼Œå…ˆä¸ºå—å½±å“çš„ä»£ç è¡¥å……æµ‹è¯•
2. **å¿«ç…§ä¿æŠ¤**ï¼šTerminalRenderer è¾“å‡ºä½¿ç”¨å¿«ç…§æµ‹è¯•
3. **æ¥å£ä¸å˜æ€§**ï¼šé‡æ„å†…éƒ¨å®ç°ï¼Œä¿æŒå…¬å¼€ API ç­¾åä¸å˜
4. **æŒç»­é›†æˆ**ï¼šæ¯æ¬¡ PR å¿…é¡»é€šè¿‡å…¨é‡æµ‹è¯•

### 6.2 æµ‹è¯•è¦†ç›–ç›®æ ‡

| æ¨¡å— | å½“å‰ | Phase 1 å | Phase 2 å |
|------|------|-----------|-----------|
| agent/ | ä½ | æ ¸å¿ƒè·¯å¾„è¦†ç›– | â‰¥ 80% |
| tools/ | ä¸­ | handler å…¨è¦†ç›– | â‰¥ 85% |
| skills/ | ä½ | ç”Ÿå‘½å‘¨æœŸè¦†ç›– | â‰¥ 80% |
| cli/ | ä½ | å‘½ä»¤æµ‹è¯• | â‰¥ 70% |
| providers/ | ä¸­ | ä¿æŒ | â‰¥ 80% |

---

## ä¸ƒã€éªŒæ”¶æ ‡å‡†

### Phase 1 éªŒæ”¶
- [ ] `madge --circular src/` è¾“å‡ºä¸ºç©ºï¼ˆæ— å¾ªç¯ä¾èµ–ï¼‰
- [ ] æ‰€æœ‰æ–‡ä»¶ â‰¤ 300 è¡Œ
- [ ] Agent ä¸»å¾ªç¯ executeLoop() åµŒå¥—ä¸è¶…è¿‡ 2 å±‚
- [ ] ç»Ÿä¸€é”™è¯¯ä½“ç³»å·²å»ºç«‹ï¼Œæ— æ··åˆ throw/return æ¨¡å¼
- [ ] æ ¸å¿ƒæ¨¡å—æµ‹è¯•è¦†ç›– â‰¥ 60%

### Phase 2 éªŒæ”¶
- [ ] BashRouter ä½¿ç”¨å£°æ˜å¼è·¯ç”±è¡¨
- [ ] SkillManager æ‹†åˆ†ä¸º â‰¤ 4 ä¸ªå­æ¨¡å—
- [ ] CLI å‘½ä»¤æŒ‰ç±»å‹åˆ†ç¦»
- [ ] æ ¸å¿ƒæ¨¡å—æµ‹è¯•è¦†ç›– â‰¥ 80%

### Phase 3 éªŒæ”¶
- [ ] æŠ€èƒ½è‡ªåŠ¨ç”Ÿæˆæœ‰æ•ˆç‡ â‰¥ 90%
- [ ] æŠ€èƒ½å¤ç”¨ç‡ â‰¥ 80%
- [ ] å¤–æºæŠ€èƒ½å¯¼å…¥æˆåŠŸç‡ â‰¥ 85%
- [ ] äº‹ä»¶æ€»çº¿å’ŒåŸºç¡€æŒ‡æ ‡æ”¶é›†å°±ç»ª

---

## å…«ã€æ€»ç»“

Synapse Agent å·²å…·å¤‡æ‰å®çš„æ ¸å¿ƒæ¶æ„ï¼ˆä¸‰å±‚å·¥å…·æŠ½è±¡ã€æŠ€èƒ½ç³»ç»Ÿã€Provider æ¥å£ï¼‰ï¼Œæ•´ä½“å®ç°åº¦è¾¾åˆ° 70-75%ã€‚æœ¬æ¬¡é‡æ„èšç„¦äºï¼š

1. **æ¶ˆé™¤æ¶æ„å€ºåŠ¡**ï¼ˆå¾ªç¯ä¾èµ–ã€God Objectã€å¤æ‚åº¦ï¼‰â€” è®©ä»£ç å¯ç»´æŠ¤
2. **å¼ºåŒ–æ ¸å¿ƒç‰¹è‰²**ï¼ˆæŠ€èƒ½ç”Ÿæˆè´¨é‡ã€æœç´¢å¤ç”¨ã€å¤–æºèåˆï¼‰â€” è®©ç†å¿µå¯éªŒè¯
3. **å»ºç«‹è´¨é‡åŸºçº¿**ï¼ˆæµ‹è¯•ã€é”™è¯¯å¤„ç†ã€å¯è§‚æµ‹æ€§ï¼‰â€” è®©ç³»ç»Ÿå¯ä¿¡èµ–

é‡æ„éµå¾ª"å…ˆç¨³åä¼˜"çš„åŸåˆ™ï¼šPhase 1 å»ºç«‹å®‰å…¨ç½‘å’Œæ¶ˆé™¤é£é™©ï¼ŒPhase 2 æå‡æ¨¡å—è´¨é‡ï¼ŒPhase 3 å¼ºåŒ–ä¸šåŠ¡èƒ½åŠ›ã€‚æ¯ä¸ª Phase ç‹¬ç«‹å¯äº¤ä»˜ã€ç‹¬ç«‹å¯éªŒæ”¶ã€‚
