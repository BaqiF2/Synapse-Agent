# 技能增强触发效率提升 — 需求提案

## 1. 背景与问题

### 1.1 问题描述
当前系统在“技能增强开关开启”时，实际触发路径存在明显漏触发：主流程依赖 Stop Hook，在对话正常结束后才会进入增强评估；进入评估后又存在“必须检测到 TodoWrite 调用”的硬门槛。该门槛导致大量具备复用价值的复杂任务无法进入技能增强流程，例如多工具排障、配置修复、文件重构等场景。这使“自动沉淀技能”的核心价值未能稳定兑现，用户虽然开启了能力，但体感仍是“很难触发”。业务层面的问题不是“是否能增强”，而是“能否在高价值任务完成后稳定、可解释地触发增强”，并将触发逻辑从单点硬条件升级为更符合任务复杂度的综合判定。

### 1.2 影响范围
- Universality assessment: 通用需求。该问题影响所有开启自动增强的用户，而非单个场景。
- Affected roles/teams: 终端用户、维护技能库的研发人员、负责提示词与流程质量的产品/工程角色。
- Current pain points:
- 用户开启后依然频繁无触发，预期落差大。
- 触发原因不可解释，难以调参。
- 技能沉淀速度慢，重复劳动无法被及时固化。
- 触发逻辑与真实复杂任务特征不匹配。

### 1.3 问题域边界
本提案聚焦“触发判定与触发后的执行策略”，即何时触发、为何触发、触发后是否自动执行。范围内包括评分信号、阈值、执行策略、日志可观测性与失败兜底。范围外包括技能内容生成算法重写、技能文档模板重构、模型替换、跨会话去重策略优化（本迭代明确为不去重）。

## 2. 用户故事

### 2.1 核心用户故事
> 作为 Synapse Agent 使用者，我希望在开启技能增强后，系统能基于任务复杂度更稳定地触发增强，以便及时沉淀可复用 SOP，减少重复劳动。

### 2.2 扩展用户故事
> 作为 Synapse Agent 使用者，我希望触发条件是可解释的评分模型，而不是单一硬条件，这样我能理解为什么触发或未触发。

> 作为 Synapse Agent 使用者，我希望达到触发阈值后自动执行增强，而不是额外交互确认，从而保持流程连续性。

> 作为 Synapse Agent 使用者，我希望本迭代不做去重冷却，只要达到阈值就触发，最大化召回潜在高价值技能。

## 3. 需求细化

### 3.1 功能性需求
| ID | Description | Priority (MoSCoW) | Source |
|----|------------|-------------------|--------|
| FR-001 | 自动增强开关为 `on` 时，系统必须在任务正常结束后进入增强评估流程 | Must have | 核心用户故事 |
| FR-002 | 触发判定必须使用“评分模型”替代“TodoWrite 硬门槛” | Must have | 扩展用户故事 2 |
| FR-003 | 评分信号默认包含：工具调用数、工具多样性、错误恢复、写入/编辑行为、用户澄清次数 | Must have | 扩展用户故事 1/2 |
| FR-004 | 默认分值为：工具调用>=3(+1)、不同工具>=2(+1)、错误并修复(+2)、写入/编辑(+1)、澄清>=2(+1) | Must have | 已确认决策 |
| FR-005 | 默认阈值为保守档：总分>=3触发增强 | Must have | 已确认决策 |
| FR-006 | 达到阈值后必须自动执行增强，不需要用户二次确认 | Must have | 扩展用户故事 3 |
| FR-007 | 本迭代不做去重冷却；每次达标任务均可触发增强 | Must have | 扩展用户故事 4 |
| FR-008 | 未触发时必须记录未触发原因码（如 `LOW_SCORE`、`AUTO_ENHANCE_OFF`） | Should have | 可运维性 |
| FR-009 | 触发后执行失败时必须返回明确失败原因并保持主任务结果可用 | Must have | 可靠性 |
| FR-010 | 需要支持保守/中性/激进阈值档位配置（默认保守） | Should have | 可调优需求 |

### 3.2 非功能性需求
| ID | Description | Acceptance Criteria | Priority |
|----|------------|-------------------|----------|
| NFR-001 | 触发评估性能开销可控 | 单次评分计算耗时 P95 < 100ms（不含子代理执行） | Must |
| NFR-002 | 触发可解释性 | 每次评估日志包含：各信号命中、总分、阈值、最终决策 | Must |
| NFR-003 | 错误隔离 | 增强失败不得中断主任务输出链路 | Must |
| NFR-004 | 成本可控 | 默认阈值下，增强触发率应高于现状且不过度放大 token 消耗（需灰度观测） | Should |
| NFR-005 | 可测试性 | 每个信号独立可测，阈值边界（2/3/4 分）有明确单测覆盖 | Must |

### 3.3 关键决策记录
| Decision ID | Question | Conclusion | Rationale |
|------------|----------|-----------|-----------|
| D-001 | 触发策略选型 | 平衡方案 | 在召回率和成本间折中 |
| D-002 | 默认阈值 | 保守档（>=3） | 优先降低误触发 |
| D-003 | 信号分值 | 采用默认分值表 | 兼顾复杂度与可解释性 |
| D-004 | 达标后行为 | 自动执行 | 保持用户流程连续 |
| D-005 | 去重策略 | 不去重 | 当前阶段优先召回 |

## 4. MoSCoW 优先级总览

### Must Have
- 用评分模型替代 TodoWrite 单点门槛。
- 落地默认信号与分值。
- 默认阈值 `>=3`。
- 达标自动执行增强。
- 增强失败不影响主任务结果。

### Should Have
- 未触发原因码日志。
- 阈值档位配置（保守/中性/激进）。
- 触发率与成本灰度观测指标。

### Could Have
- 后续可增加信号权重自动调参。
- 后续引入任务类型差异化阈值。

### Won't Have（本迭代不做）
- 去重冷却。
- 技能生成算法大改。
- 跨会话语义聚类去重。

## 5. 约束与假设

### 5.1 约束
- 当前触发链路仍基于 Stop Hook，异常结束任务不在本迭代覆盖范围。
- 评分信号优先复用现有会话与工具调用结构，避免大规模架构调整。
- 当前处于开发阶段，优先重构可读性与可测性，不优先兼容历史触发细节。

### 5.2 假设
- 任务复杂度信号能比 TodoWrite 条件更准确识别“值得沉淀”的任务。
- 默认 `>=3` 阈值在初期可显著提升触发率且可控。
- 不去重不会在短期内造成不可接受的技能噪音，后续可通过观测验证。

## 6. 开放问题
| ID | Question | Status | Owner |
|----|---------|--------|-------|
| Q-001 | “错误并修复”信号的判定细则（同轮修复 vs 跨轮修复）是否需要更严格定义 | Resolved（宽松口径） | 用户确认 |
| Q-002 | “用户澄清>=2次”的识别规则是否使用关键词、意图分类还是混合策略 | Resolved（LLM 语义判定） | 用户确认 |
| Q-003 | 触发率与 token 成本的目标区间基线值（当前值）需先建立观测样本 | Open | 研发 |
