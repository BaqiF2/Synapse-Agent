# 第二部分（续）：技能强化系统

### 4.5 技能强化 Agent（阶段 2 核心）

技能强化 Agent 是实现"自我成长"能力的核心组件，负责在任务完成后分析执行过程，自动生成新技能或强化已有技能。

#### 4.5.1 触发时机

- **任务成功完成后**：主 Agent 在退出 Agent Loop 前，判断是否需要调用技能强化 Agent
- **触发条件**：
  - 任务执行过程中发现了可复用的模式或工作流
  - 使用了已有技能但执行效果不理想
  - 多次执行相似任务，存在优化空间
  - 用户手动触发技能强化

#### 4.5.2 工作流程

```
任务完成 → 主 Agent 判断 → 调用技能强化 Agent → 分析执行记录 → 决策 → 生成/更新技能 → 更新索引
```

**详细步骤**：

1. **接收上下文**：
   - 完整的任务描述和对话历史
   - 执行过程中的工具调用记录
   - 已加载的技能列表（如果有）
   - 任务执行结果和成功/失败状态

2. **分析执行模式**：
   - 识别重复的工具调用序列
   - 提取关键的 Bash 命令组合
   - 分析任务的领域和类型
   - 评估是否有可复用价值

3. **做出决策**：

   **情况 A：任务完全由已有技能完成**
   - 无需操作，直接返回

   **情况 B：任务部分使用了技能，但有改进空间**
   - 识别改进点（如缺失的步骤、错误的工具选择）
   - 强化已有技能：更新 SKILL.md，补充新的执行步骤或最佳实践
   - 更新技能文件并保持索引同步

   **情况 C：任务未使用技能，但发现可复用模式**
   - 判断是否值得创建新技能（执行步骤 ≥ 3，有明确工作流）
   - 生成新技能：创建技能目录和 SKILL.md 文件
   - 如果使用了新工具，调用工具转 Bash Agent 转换为 Field Bash
   - 更新技能索引文件

4. **生成/更新技能**：

   **重要说明**：技能生成的具体规则、模板和格式由技能强化 Agent 的配置决定，而非硬编码在系统中。

   **技能强化 Agent 的配置**：

   - **系统提示词**：定义技能强化 Agent 的角色、目标和基本行为规范
   - **配备的技能**：技能强化 Agent 可以加载专门的技能来指导其工作，例如：
     - `creating-skills`：指导如何创建新技能的技能（元技能）
     - `enhancing-skills`：指导如何强化已有技能的技能
     - `evaluating-skills`：评估技能质量和适用性的技能
   - **可用工具**：write、read、glob、grep 等 Agent Bash 工具

   **元循环设计的优势**：
   - **可进化**：通过更新 `creating-skills` 技能，改进技能生成能力本身
   - **灵活性**：不同场景可以使用不同的技能生成策略
   - **自我改进**：技能强化 Agent 可以根据反馈优化自己的技能生成模板
   - **符合核心理念**：体现"技能 + LLM = 大脑"和"一切都是工具"

   **技能生成示例流程**：

   ```
   技能强化 Agent 启动
   → 加载 creating-skills 技能
   → 按照 creating-skills 中的指导分析任务
   → 生成符合模板的 SKILL.md
   → 使用 write 工具保存文件
   → 更新索引
   ```

   **参考模板**（由 `creating-skills` 技能定义）：

   以下模板仅作为参考，实际模板应在 `creating-skills` 技能中定义和维护：

   ```markdown
   ---
   name: [动名词格式，如 analyzing-logs]
   description: [简要描述功能 + 使用时机 + 关键词。用第三人称书写，最多1024字符]
   ---

   # [技能标题]

   ## 快速开始

   [最常用的执行流程，包含具体的 Bash 命令示例]

   \`\`\`bash
   # 具体的命令序列
   glob "**/*.log"
   read error.log
   grep "ERROR|WARN" error.log
   \`\`\`

   ## 执行步骤

   [详细的工作流程，分步骤说明]

   ## 最佳实践

   - [从任务中总结的经验]
   - [特定场景的注意事项]

   ## 示例

   [提供输入/输出对]
   ```

   **模板说明**：
   - **简洁优先**：假设 Claude 已经很聪明，只提供它不知道的上下文
   - **具体命令**：提供可直接执行的 Bash 命令，避免"使用某工具处理"这类抽象描述
   - **第三人称描述**：description 字段用第三人称书写（如"分析日志文件"而非"我可以分析日志文件"）
   - **关键词丰富**：description 包含任务相关的关键词，便于技能搜索匹配
   - **渐进式披露**：主体内容保持在 500 行以内，详细内容放入单独文件

   **技能强化策略**：

   对于已有技能的强化：
   - **补充示例**：添加新的使用场景和输入/输出对
   - **优化步骤**：改进执行顺序，移除冗余操作
   - **添加反馈循环**：引入验证步骤（如"运行验证 → 修复错误 → 重复"）
   - **更新最佳实践**：记录本次任务中发现的新经验
   - **避免过度详细**：移除不必要的解释，保持简洁

   **模板演进**：
   - 初始版本：参考 Claude Code Skills 官方最佳实践
   - 随着使用：技能强化 Agent 可以根据生成技能的质量反馈，更新 `creating-skills` 技能
   - 领域定制：不同领域（programming/finance 等）可以有专门的技能生成策略

5. **更新文件系统**：
   - 保存/更新 SKILL.md 文件到 `~/.synapse/skills/<domain>/<skill-name>/`
   - 更新技能索引文件 `index.json`
   - 如有新工具，保存工具定义到 `~/.synapse/tools/field/<domain>/`
   - 如有额外参考文件，保存到技能目录下（如 REFERENCE.md、EXAMPLES.md）

#### 4.5.3 技能质量标准

技能强化 Agent 在生成新技能时的质量标准，同样由其配备的技能（如 `evaluating-skills`）定义。以下是基础标准：

**必要性判断**：
- 任务执行步骤 ≥ 3 个独立操作
- 工作流有明确的模式和逻辑
- 未来可能重复执行（不是一次性任务）

**质量要求**：
- Description 包含关键词和使用场景，便于技能搜索匹配
- SKILL.md 提供具体的 Bash 命令示例，而非抽象描述
- 执行步骤清晰，遵循最佳实践格式
- 保持简洁（SKILL.md 主体 < 500 行），详细内容放入 REFERENCE.md

**领域分类**：
- 根据任务类型自动分类到合适的领域（programming/finance/general 等）
- 如果是新领域，创建新的领域目录并更新索引

#### 4.5.4 工具集成

技能强化过程中，如果发现新工具或工具组合：

1. **识别新工具**：
   - 检查任务执行记录中使用的工具
   - 对比已有的工具索引 (`~/.synapse/tools/index.json`)
   - 识别尚未转换为 Bash 的工具

2. **调用工具转 Bash Agent**：
   ```
   任务完成 → 技能强化 Agent → 发现新工具 → 调用工具转 Bash Agent → 生成 Field Bash → 更新工具索引
   ```

3. **在技能中引用**：
   - SKILL.md 中使用新生成的 Field Bash 命令
   - 确保技能可以独立执行，无外部依赖

#### 4.5.5 示例流程

```
场景：用户多次要求"分析日志文件并找出错误"

第一次执行：
- 主 Agent 手动执行：grep "ERROR" log.txt，分析结果
- 任务完成后 → 技能强化 Agent 判断：发现可复用模式

技能强化 Agent 执行：
1. 分析执行记录：
   - 工具调用：read log.txt, grep "ERROR|WARN", ...
   - 执行步骤：读取日志 → 搜索错误 → 分类统计 → 生成报告

2. 决策：创建新技能 "analyzing-logs"

3. 生成技能文件：
   ~/.synapse/skills/general/analyzing-logs/SKILL.md

4. 更新索引：
   {
     "general": {
       "description": "通用技能，适用于多种场景的任务",
       "skills": [
         {
           "name": "analyzing-logs",
           "description": "分析日志文件，提取错误和警告信息。当用户需要排查问题、统计日志或生成日志报告时使用此技能。",
           "path": "general/analyzing-logs/SKILL.md"
         }
       ]
     }
   }

第二次执行相同任务：
- 技能搜索 Agent 找到 "analyzing-logs" 技能
- 主 Agent 加载技能并按指令执行
- 执行效率显著提升
```
