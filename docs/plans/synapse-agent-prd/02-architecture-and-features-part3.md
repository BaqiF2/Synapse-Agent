# 第二部分（续）：技能强化系统

### 4.5 技能强化功能（阶段 2 核心）

技能强化是实现"自我成长"能力的核心功能，负责在任务完成后分析执行过程，自动生成新技能或强化已有技能。

#### 4.5.1 架构设计

**与技能搜索共享 Skill 子 Agent**：

技能强化功能由 Skill 子 Agent 承担，与技能搜索共享同一个持久化子 Agent 和 LLM 会话上下文。

**Skill 子 Agent 职责**（持久化子 Agent，共享 LLM 会话）：

1. **技能搜索** - `skill search "<描述>"` → LLM 语义匹配
2. **技能强化** - `skill enhance [options]` → 分析会话历史，新增/更新技能

**Agent 程序直接提供的工具**（不经过子 Agent）：

- **技能加载** - `skill load <name>` → 纯代码逻辑，从内存映射读取 SKILL.md

**命令路由**：

| 命令 | 路由方式 |
|------|----------|
| `skill search "<描述>"` | → Skill 子 Agent（LLM 语义匹配） |
| `skill load <name>` | → Shell Command 解析器（纯代码逻辑） |
| `skill enhance [options]` | → Skill 子 Agent（LLM 分析强化） |

**共享上下文优势**：

- 强化时可利用搜索时已加载的技能元数据
- 多次强化调用之间保持记忆，避免重复分析
- 可以追踪同一 session 内的多次技能使用情况

#### 4.5.2 开关机制与命令设计

**自动强化开关**：

- **默认状态**：关闭
- **开启方式**：用户执行 `skill enhance --on`
- **关闭方式**：用户执行 `skill enhance --off`
- **费用提示**：开启时明确告知用户会产生额外 token 消耗

```
> skill enhance --on

⚠️ 开启自动技能强化功能
   每轮任务结束后将自动分析是否需要强化技能
   这将产生额外的 token 消耗

   使用 `skill enhance --off` 可随时关闭

✓ 自动强化已开启
```

**命令集**：

| 命令 | 功能 |
|------|------|
| `skill enhance` | 手动触发强化，基于当前 session 上下文 |
| `skill enhance --on` | 开启自动强化 |
| `skill enhance --off` | 关闭自动强化 |

**开关状态持久化**：存储在 `~/.synapse/settings.json` 中，跨 session 保持。

#### 4.5.3 自动触发机制

**触发时机**：

当自动强化开启后，每轮任务结束时（用户输入 prompt → Agent 完成任务返回文本），主 Agent 内联判断是否需要调用技能强化。

**判断依据**（主 Agent 基于上下文反思）：

- 任务复杂度：执行步骤数量、工具调用次数
- 用户澄清次数：是否多次补充说明需求
- 工具使用情况：是否引入多种 Extension Shell Command
- 脚本生成：是否主动生成脚本才完成任务
- 技能使用情况：使用了哪些 skill，执行效果如何
- 可复用性：是否发现可复用的工作流模式

**判断流程**：

```
任务即将完成
    │
    ▼
主 Agent 检查：自动强化是否开启？
    │
    ├─ 否 → 直接返回结果给用户
    │
    └─ 是 → 主 Agent 内联反思：本次任务是否值得强化？
              │
              ├─ 否 → 直接返回结果给用户
              │
              └─ 是 → 调用 skill enhance → 返回结果 + 强化报告
```

**设计要点**：判断过程在主 Agent 内完成，不产生额外 LLM 调用开销。

#### 4.5.4 强化执行流程

**上下文传递**：

主 Agent 调用 `skill enhance` 时，传递会话历史文件路径给 Skill 子 Agent：

```
skill enhance --conversation ~/.synapse/conversations/<session-id>.jsonl
```

**会话历史截断处理**：

- Skill 子 Agent 读取会话历史时，只取最近的固定 token 数量（如 `MAX_ENHANCE_CONTEXT_TOKENS`）
- 从文件末尾向前读取，确保分析的是最近完成的任务
- 截断阈值可在 `~/.synapse/settings.json` 中配置

**Skill 子 Agent 执行流程**：

```
接收会话历史路径
    │
    ▼
读取会话历史文件（截断处理，只取最近 N tokens）
    │
    ▼
分析执行过程：
  - 识别任务类型
  - 提取工具调用序列
  - 识别使用的技能及效果
  - 发现可复用模式
    │
    ▼
自主决策：新增技能 or 强化已有技能 or 无需操作
    │
    ▼
执行操作：
  - 新增/强化技能目录结构：
    ~/.synapse/skills/<name>/
    ├── SKILL.md          # 创建/更新主文档
    ├── references/       # 如有详细参考资料
    └── scripts/          # 如有可执行脚本
  - 更新索引：~/.synapse/skills/index.json
    │
    ▼
返回详细报告
```

**Skill 子 Agent 可用工具**：

- `read` - 读取会话历史、已有技能文件
- `write` - 创建新文件（SKILL.md、references、scripts）
- `edit` - 编辑已有文件（强化技能时使用）
- `glob` - 扫描技能目录
- `grep` - 搜索技能内容

#### 4.5.5 强化结果反馈

**详细报告格式**：

**新增技能时**：
```
技能强化完成：
- 操作：新增技能
- 名称：analyzing-logs
- 包含工具：grep, read, glob
```

**强化已有技能时**：
```
技能强化完成：
- 操作：强化技能
- 名称：code-review
- 强化内容：
  - 新增 Python 类型检查步骤
  - 补充错误处理最佳实践
```

**无需操作时**：
```
技能强化分析完成：
- 结论：无需强化
- 原因：本次任务已由现有技能完整覆盖，执行效果良好
```

#### 4.5.6 新增 vs 强化的决策逻辑

**决策方式**：完全由 Skill 子 Agent（LLM）自主判断

**Skill 子 Agent 分析维度**：

1. **技能使用情况**
   - 本次任务是否加载并使用了某个技能
   - 技能执行过程中是否有偏离或补充步骤

2. **执行效果评估**
   - 任务是否顺利完成
   - 是否有改进空间（遗漏步骤、更优工具选择等）

3. **模式识别**
   - 是否发现全新的可复用工作流
   - 工具调用序列是否有明确的模式

**决策结果**：

| 情况 | 决策 |
|------|------|
| 任务使用了技能，执行效果良好 | 无需操作 |
| 任务使用了技能，但有改进空间 | 强化该技能 |
| 任务未使用技能，发现可复用模式 | 新增技能 |
| 任务简单，无复用价值 | 无需操作 |

**设计要点**：不设置硬性规则，信任 LLM 基于上下文的综合判断能力。

#### 4.5.7 技能生成规范

**重要说明**：技能生成的具体规则、模板和格式由 Skill 子 Agent 的配置决定，而非硬编码在系统中。

**Skill 子 Agent 的配置**：

- **系统提示词**：定义 Skill 子 Agent 的角色、目标和基本行为规范
- **配备的技能**：Skill 子 Agent 可以加载专门的技能来指导其工作，例如：
  - `creating-skills`：指导如何创建新技能的技能（元技能）
  - `enhancing-skills`：指导如何强化已有技能的技能
  - `evaluating-skills`：评估技能质量和适用性的技能
- **可用工具**：write、read、glob、grep 等 Agent Shell Command 工具

**元循环设计的优势**：

- **可进化**：通过更新 `creating-skills` 技能，改进技能生成能力本身
- **灵活性**：不同场景可以使用不同的技能生成策略
- **自我改进**：Skill 子 Agent 可以根据反馈优化自己的技能生成模板
- **符合核心理念**：体现"技能 + LLM = 大脑"和"一切都是工具"

**参考模板**（由 `creating-skills` 技能定义）：

以下模板仅作为参考，实际模板应在 `creating-skills` 技能中定义和维护：

```markdown
---
name: [动名词格式，如 analyzing-logs]
description: [简要描述功能 + 使用时机 + 关键词。用第三人称书写，最多1024字符]
---

# [技能标题]

## 快速开始

[最常用的执行流程，包含具体的 Bash 命令示例]

\`\`\`bash
# 具体的命令序列
glob "**/*.log"
read error.log
grep "ERROR|WARN" error.log
\`\`\`

## 执行步骤

[详细的工作流程，分步骤说明]

## 最佳实践

- [从任务中总结的经验]
- [特定场景的注意事项]

## 示例

[提供输入/输出对]
```

**模板说明**：

- **简洁优先**：假设 Claude 已经很聪明，只提供它不知道的上下文
- **具体命令**：提供可直接执行的 Bash 命令，避免"使用某工具处理"这类抽象描述
- **第三人称描述**：description 字段用第三人称书写（如"分析日志文件"而非"我可以分析日志文件"）
- **关键词丰富**：description 包含任务相关的关键词，便于技能搜索匹配
- **渐进式披露**：主体内容保持在 500 行以内，详细内容放入单独文件

**技能强化策略**：

对于已有技能的强化：
- **补充示例**：添加新的使用场景和输入/输出对
- **优化步骤**：改进执行顺序，移除冗余操作
- **添加反馈循环**：引入验证步骤（如"运行验证 → 修复错误 → 重复"）
- **更新最佳实践**：记录本次任务中发现的新经验
- **避免过度详细**：移除不必要的解释，保持简洁

#### 4.5.8 工具集成

技能强化过程中，如果发现新工具或工具组合：

1. **识别新工具**：
   - 检查任务执行记录中使用的工具
   - 对比已有的工具索引 (`~/.synapse/tools/index.json`)
   - 识别尚未转换为 Bash 的工具

2. **调用工具转 Bash Agent**：
   ```
   任务完成 → Skill 子 Agent → 发现新工具 → 调用工具转 Bash Agent → 生成 Extension Shell Command → 更新工具索引
   ```

3. **在技能中引用**：
   - SKILL.md 中使用新生成的 Extension Shell Command 命令
   - 确保技能可以独立执行，无外部依赖

#### 4.5.9 完整执行流程示例

**场景**：用户执行日志分析任务，自动强化已开启

```
用户: "帮我分析 error.log 找出所有报错原因"

┌─────────────────────────────────────────────────────────────┐
│ 1. 主 Agent 执行任务                                        │
│    - skill search "分析日志文件"                            │
│    - 未找到匹配技能                                         │
│    - 手动执行：read error.log → grep "ERROR" → 分析结果     │
│    - 任务完成                                               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. 主 Agent 内联判断：是否需要强化？                         │
│    - 自动强化已开启 ✓                                       │
│    - 任务涉及多步骤工具调用 ✓                                │
│    - 发现可复用模式 ✓                                       │
│    - 决策：调用 skill enhance                               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. Skill 子 Agent 执行强化                                  │
│    - 读取 ~/.synapse/conversations/<session>.jsonl          │
│    - 截断处理，取最近 N tokens                               │
│    - 分析执行过程，识别日志分析工作流                        │
│    - 决策：新增技能 "analyzing-logs"                        │
│    - 创建 ~/.synapse/skills/analyzing-logs/SKILL.md         │
│    - 更新 index.json                                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. 返回结果给用户                                           │
│                                                             │
│    [任务执行结果...]                                        │
│                                                             │
│    技能强化完成：                                           │
│    - 操作：新增技能                                         │
│    - 名称：analyzing-logs                                   │
│    - 包含工具：grep, read, glob                             │
└─────────────────────────────────────────────────────────────┘
```

**第二次执行相同任务**：

```
用户: "帮我分析 app.log 中的错误"

┌─────────────────────────────────────────────────────────────┐
│ 1. 主 Agent 执行任务                                        │
│    - skill search "分析日志文件"                            │
│    - 找到匹配技能：analyzing-logs                           │
│    - skill load analyzing-logs                              │
│    - 按照技能指令执行任务                                   │
│    - 执行效率显著提升                                       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. 主 Agent 内联判断：是否需要强化？                         │
│    - 任务由现有技能完整覆盖                                  │
│    - 执行效果良好                                           │
│    - 决策：无需强化                                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. 直接返回结果给用户                                       │
│                                                             │
│    [任务执行结果...]                                        │
└─────────────────────────────────────────────────────────────┘
```
