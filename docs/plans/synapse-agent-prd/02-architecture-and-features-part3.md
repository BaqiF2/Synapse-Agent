# 第二部分（续）：技能强化系统

### 4.5 技能强化功能（阶段 2 核心）

技能强化是实现"自我成长"能力的核心功能，负责在任务完成后分析执行过程，自动生成新技能或强化已有技能。

#### 4.5.1 架构设计

**与技能搜索共享 Skill 子 Agent**：

技能强化功能由 Skill 子 Agent 承担，与技能搜索共享同一个持久化子 Agent 和 LLM 会话上下文。

**Skill 子 Agent 职责**（持久化子 Agent，共享 LLM 会话）：

1. **技能搜索** - `task:skill:search --prompt ... --description ...` → LLM 语义匹配
2. **技能强化** - `task:skill:enhance --prompt ... --description ...` → 分析会话历史，新增/更新技能

**Agent 程序直接提供的工具**（不经过子 Agent）：

- **技能加载** - `skill:load <name>` → 纯代码逻辑，从磁盘读取 SKILL.md（带缓存）

**命令路由**：

| 命令 | 路由方式 |
|------|----------|
| `task:skill:search --prompt ... --description ...` | → Skill 子 Agent（LLM 语义匹配） |
| `skill:load <name>` | → Shell Command 解析器（纯代码逻辑） |
| `task:skill:enhance --prompt ... --description ...` | → Skill 子 Agent（LLM 分析强化） |

**共享上下文优势**：

- 强化时可利用搜索时已加载的技能元数据
- 多次强化调用之间保持记忆，避免重复分析
- 可以追踪同一 session 内的多次技能使用情况

#### 4.5.2 开关机制与命令设计

**自动强化开关（REPL 命令）**：

- **默认状态**：关闭
- **开启方式**：用户执行 `/skill enhance --on`
- **关闭方式**：用户执行 `/skill enhance --off`
- **状态查看**：用户执行 `/skill enhance`
- **费用提示**：开启时明确告知用户会产生额外 token 消耗

```
> /skill enhance --on

⚠️ 开启自动技能强化功能
   每轮任务结束后将自动分析是否需要强化技能
   这将产生额外的 token 消耗

   使用 `/skill enhance --off` 可随时关闭

✓ 自动强化已开启
```

**命令集**：

| 命令 | 功能 |
|------|------|
| `/skill enhance` | 查看自动强化状态 |
| `/skill enhance --on` | 开启自动强化 |
| `/skill enhance --off` | 关闭自动强化 |
| `task:skill:enhance --prompt ... --description ...` | 手动触发强化（Agent 工具） |

> 说明：`/skill enhance --conversation` 在当前实现中不可用。

**开关状态持久化**：存储在 `~/.synapse/settings.json` 中，跨 session 保持。

#### 4.5.3 自动触发机制

**触发时机**：

当自动强化开启后，每轮任务结束时（Agent Loop 正常完成），通过 Stop Hook 触发技能强化流程。

**触发流程（当前实现）**：

```
任务完成
    │
    ▼
StopHookRegistry 触发 skill-enhance hook
    │
    ├─ 自动强化关闭 → 直接跳过
    │
    └─ 自动强化开启
         │
         ▼
读取会话历史 → 构建增强提示词 → 调用 task:skill:enhance
         │
         ▼
Skill 子 Agent 决策：create / enhance / none
```

**设计要点**：
- 是否需要强化由 Skill 子 Agent 在分析阶段自主判断
- 触发时会产生额外 LLM 调用开销

#### 4.5.4 强化执行流程

**上下文传递**：

Stop Hook 读取会话历史文件并构建提示词后，调用 Skill 子 Agent 执行强化：

```
~/.synapse/sessions/<session-id>.jsonl
```

**会话历史截断处理**：

- 读取会话历史时按字符长度截断（`skillEnhance.maxEnhanceContextChars`）
- 从文件末尾向前读取，确保分析最近完成的任务
- 阈值配置位于 `~/.synapse/settings.json`

**元技能依赖**：

- 自动强化提示词会加载元技能内容
- 读取目录由 `SYNAPSE_META_SKILLS_DIR` 指定，默认 `~/.synapse/skill`
- 当前内置元技能：`skill-creator`、`skill-enhance`

**Skill 子 Agent 执行流程**：

```
接收会话历史路径
    │
    ▼
读取会话历史文件（截断处理，只取最近 N tokens）
    │
    ▼
分析执行过程：
  - 识别任务类型
  - 提取工具调用序列
  - 识别使用的技能及效果
  - 发现可复用模式
    │
    ▼
自主决策：新增技能 or 强化已有技能 or 无需操作
    │
    ▼
执行操作：
  - 新增/强化技能目录结构：
    ~/.synapse/skills/<name>/
    ├── SKILL.md          # 创建/更新主文档
    ├── references/       # 如有详细参考资料
    └── scripts/          # 如有可执行脚本
  - 更新索引：~/.synapse/skills/index.json
    │
    ▼
返回详细报告
```

**Skill 子 Agent 可用工具**：

- `read` - 读取会话历史、已有技能文件
- `write` - 创建新文件（SKILL.md、references、scripts）
- `edit` - 编辑已有文件（强化技能时使用）
- `glob` - 扫描技能目录
- `search` - 搜索技能内容

#### 4.5.5 强化结果反馈

**详细报告格式**：

**新增技能时**：
```
技能强化完成：
- 操作：新增技能
- 名称：analyzing-logs
- 包含工具：search, read, glob
- 技能内容：
  - 分析日志文件
  - 寻找错误信息
```

**强化已有技能时**：
```
技能强化完成：
- 操作：强化技能
- 名称：code-review
- 强化内容：
  - 新增 Python 类型检查步骤
  - 补充错误处理最佳实践
```

**无需操作时**：
```
技能强化分析完成：
- 结论：无需强化
- 原因：本次任务已由现有技能完整覆盖，执行效果良好
```

#### 4.5.6 新增 vs 强化的决策逻辑

**决策方式**：完全由 Skill 子 Agent（LLM）自主判断

**Skill 子 Agent 分析维度**：

1. **技能使用情况**
   - 本次任务是否加载并使用了某个技能
   - 技能执行过程中是否有偏离或补充步骤

2. **执行效果评估**
   - 任务是否顺利完成
   - 是否有改进空间（遗漏步骤、更优工具选择等）

3. **模式识别**
   - 是否发现全新的可复用工作流
   - 工具调用序列是否有明确的模式

**决策结果**：

| 情况 | 决策 |
|------|------|
| 任务使用了技能，执行效果良好 | 无需操作 |
| 任务使用了技能，但有改进空间 | 强化该技能 |
| 任务未使用技能，发现可复用模式 | 新增技能 |
| 任务简单，无复用价值 | 无需操作 |

**设计要点**：不设置硬性规则，信任 LLM 基于上下文的综合判断能力。

#### 4.5.7 技能生成规范

**重要说明**：技能生成的具体规则、模板和格式由 Skill 子 Agent 的配置决定，而非硬编码在系统中。

**Skill 子 Agent 的配置**：

- **系统提示词**：定义 Skill 子 Agent 的角色、目标和基本行为规范
- **配备的技能**：Skill 子 Agent 可以加载专门的元技能来指导其工作，例如：
  - `skill-creator`：指导如何创建新技能
  - `skill-enhance`：指导如何强化已有技能
  - （评估类元技能当前未内置）
- **可用工具**：write、read、glob、search 等 Agent Shell Command 工具

**元循环设计的优势**：

- **可进化**：通过更新 `skill-creator` 技能，改进技能生成能力本身
- **灵活性**：不同场景可以使用不同的技能生成策略
- **自我改进**：Skill 子 Agent 可以根据反馈优化自己的技能生成模板
- **符合核心理念**：体现"技能 + LLM = 大脑"和"一切都是工具"

**参考模板**（由 `skill-creator` 技能定义）：

以下模板仅作为参考，实际模板应在 `skill-creator` 技能中定义和维护：

```markdown
---
name: [动名词格式，如 analyzing-logs]
description: [简要描述功能 + 使用时机 + 关键词。用第三人称书写，最多1024字符]
---

# [技能标题]

## 快速开始

[最常用的执行流程，包含具体的 Bash 命令示例]

\`\`\`bash
# 具体的命令序列
glob "**/*.log"
read error.log
search "ERROR|WARN" --path .
\`\`\`

## 执行步骤

[详细的工作流程，分步骤说明]

## 最佳实践

- [从任务中总结的经验]
- [特定场景的注意事项]

## 示例

[提供输入/输出对]
```

**模板说明**：

- **简洁优先**：假设 Claude 已经很聪明，只提供它不知道的上下文
- **具体命令**：提供可直接执行的 Bash 命令，避免"使用某工具处理"这类抽象描述
- **第三人称描述**：description 字段用第三人称书写（如"分析日志文件"而非"我可以分析日志文件"）
- **关键词丰富**：description 包含任务相关的关键词，便于技能搜索匹配
- **渐进式披露**：主体内容保持在 500 行以内，详细内容放入单独文件

**技能强化策略**：

对于已有技能的强化：
- **补充示例**：添加新的使用场景和输入/输出对
- **优化步骤**：改进执行顺序，移除冗余操作
- **添加反馈循环**：引入验证步骤（如"运行验证 → 修复错误 → 重复"）
- **更新最佳实践**：记录本次任务中发现的新经验
- **避免过度详细**：移除不必要的解释，保持简洁

#### 4.5.8 脚本转 Extension Shell Command

技能创建或强化时，如果在 `scripts/` 目录下添加了可执行脚本，系统会在启动时扫描生成包装器；若启用自动更新组件，则脚本变更会触发增量更新。

**转换机制**（参考 4.2.3 Skill2Bash 转换器）：

1. **启动时扫描**：扫描 `~/.synapse/skills/` 目录
2. **生成包装器**：为每个脚本生成 `skill:<skill_name>:<tool>` 命令包装器
3. **安装到 PATH**：包装器安装到 `~/.synapse/bin/`，立即可用
4. **可选自动更新**：启用自动更新组件后，脚本新增/修改会触发增量更新

**工作流程**：

```
Skill 子 Agent 创建/强化技能
    │
    ▼
在 scripts/ 目录下写入脚本文件
    │
    ▼
（可选）自动更新组件检测到变化
    │
    ▼
Skill2Bash 转换器生成命令包装器
    │
    ▼
skill:<skill_name>:<tool> 命令立即可用
```

**示例**：

```
技能强化创建了新脚本：
~/.synapse/skills/analyzing-logs/scripts/parse_error.py

启动时初始化生成（启用自动更新组件后可实时更新）：
~/.synapse/bin/skill:analyzing-logs:parse_error

SKILL.md 中可直接使用：
skill:analyzing-logs:parse_error error.log --format json
```

**设计要点**：
- **启动时生成**：默认在初始化阶段生成包装器
- **可选实时更新**：启用自动更新组件后，脚本保存可触发更新
- **自描述支持**：生成的命令包装器支持 `-h` 和 `--help` 参数

#### 4.5.9 完整执行流程示例

**场景**：用户执行日志分析任务，自动强化已开启

```
用户: "帮我分析 error.log 找出所有报错原因"

┌─────────────────────────────────────────────────────────────┐
│ 1. 主 Agent 执行任务                                        │
│    - task:skill:search --prompt "分析日志文件" --description "Search skills" │
│    - 未找到匹配技能                                         │
│    - 手动执行：read error.log → search "ERROR" --path . → 分析结果 │
│    - 任务完成                                               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. Stop Hook 触发技能强化（自动强化已开启）                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. Skill 子 Agent 执行强化                                  │
│    - 读取 ~/.synapse/sessions/<session>.jsonl               │
│    - 按字符长度截断                                         │
│    - 分析执行过程，识别日志分析工作流                        │
│    - 决策：新增技能 "analyzing-logs"                        │
│    - 创建 ~/.synapse/skills/analyzing-logs/SKILL.md         │
│    - 更新 index.json                                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. 返回结果给用户                                           │
│                                                             │
│    [任务执行结果...]                                        │
│                                                             │
│    技能强化完成：                                           │
│    - 操作：新增技能                                         │
│    - 名称：analyzing-logs                                   │
│    - 包含工具：search, read, glob                           │
└─────────────────────────────────────────────────────────────┘
```

**第二次执行相同任务**：

```
用户: "帮我分析 app.log 中的错误"

┌─────────────────────────────────────────────────────────────┐
│ 1. 主 Agent 执行任务                                        │
│    - task:skill:search --prompt "分析日志文件" --description "Search skills" │
│    - 找到匹配技能：analyzing-logs                           │
│    - skill:load analyzing-logs                              │
│    - 按照技能指令执行任务                                   │
│    - 执行效率显著提升                                       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. Stop Hook 触发技能强化（自动强化已开启）                  │
│    - 子 Agent 判断无需强化                                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. 直接返回结果给用户                                       │
│                                                             │
│    [任务执行结果...]                                        │
└─────────────────────────────────────────────────────────────┘
```
