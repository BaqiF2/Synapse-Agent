# TodoWrite 和 Task 使用引导增强设计

## 背景

当前项目的 Agent 在遇到复杂任务时不太积极使用 `TodoWrite` 和 `Task` 工具。需要通过增强系统提示词来引导 Agent 更主动地使用这些工具。

## 设计目标

1. 让 Agent 在复杂任务时更倾向于使用 TodoWrite 来规划和跟踪任务
2. 让 Agent 在需要并行或专业能力时使用 Task 子智能体
3. 明确 TodoWrite 和 Task 的协作关系

## 策略

采用 **强制规则 + 启发式引导** 的分层策略：

- **强制规则**：满足特定条件时 MUST 使用
- **启发式引导**：其他复杂场景提供 Consider using 建议

## TodoWrite 使用决策

### 强制使用条件（满足任一）

1. 任务包含 ≥3 个明确步骤
2. 用户使用信号词：分步、逐步、计划、step by step、checklist、按顺序
3. 预判任务将修改 ≥3 个文件

### 建议使用条件

1. 任务描述模糊，需要先拆解再执行
2. 涉及多个系统或模块的协调修改
3. 需要先调研/探索才能确定具体步骤

### 不使用条件

1. 单一明确操作（如"读取某文件"、"修复这个 typo"）
2. 步骤少于 3 且目标清晰

## Task 使用决策

### 建议使用条件

1. 有 ≥2 个相互独立的子任务，可并行执行
2. 子任务需要专业能力（代码探索用 `task:explore`，技能搜索用 `task:skill:search`）
3. 子任务会产生大量输出，需隔离以避免污染主对话上下文

## TodoWrite 与 Task 协作模式

**原则：TodoWrite 为主，Task 为辅**

1. 先用 TodoWrite 拆解整体任务
2. 某些 todo 项通过 Task 并行/专业执行
3. Task 完成后更新 TodoWrite 状态

## 实施变更

修改文件：`src/agent/prompts/command-system.md`

1. 在 TodoWrite 章节添加 "使用决策" 小节
2. 在 task 章节添加 "使用决策" 小节和协作示例

## 验证清单

| 维度 | 验证问题 | 状态 |
|------|----------|------|
| 输入/输出格式 | 强制条件和建议条件的判断标准是否明确？ | ✓ 已明确阈值和信号词 |
| 边界规则 | TodoWrite 和 Task 的优先级/协作关系是否清晰？ | ✓ TodoWrite 为主，Task 为辅 |
| 可验证性 | 每个规则是否可独立判断？ | ✓ 条件互不依赖 |
| 歧义检查 | 是否有可能被不同理解的描述？ | ✓ 使用了具体数字和示例 |
