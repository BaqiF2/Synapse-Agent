[
  {
    "category": "functional",
    "prd": "2026-02-06-task-explore-parallel-design.md#2-目录自动拆分",
    "description": "目录检测函数 - 检测目标路径下的子目录",
    "bdd": [
      {
        "title": "检测子目录 - 正常情况",
        "description": "目标路径存在且有多个子目录时，返回子目录列表",
        "steps": [
          "准备一个目录，包含 3 个子目录: agent/, cli/, tools/",
          "调用 detectSubDirectories(basePath)"
        ],
        "expected": "返回包含 3 个路径的数组 (Default assumption: 使用文件系统默认顺序，非字母排序)"
      },
      {
        "title": "检测子目录 - 过滤隐藏目录",
        "description": "自动过滤以 . 开头的隐藏目录",
        "steps": [
          "准备一个目录，包含: src/, .git/, .cache/, lib/",
          "调用 detectSubDirectories(basePath)"
        ],
        "expected": "返回 [src/, lib/]，不包含 .git/ 和 .cache/"
      },
      {
        "title": "检测子目录 - 超过数量限制",
        "description": "子目录数量超过 MAX_PARALLEL_TASKS 时，只返回前 N 个",
        "steps": [
          "设置 MAX_PARALLEL_TASKS = 3",
          "准备一个目录，包含 5 个子目录: a/, b/, c/, d/, e/",
          "调用 detectSubDirectories(basePath)"
        ],
        "expected": "返回前 3 个子目录的路径数组"
      },
      {
        "title": "检测子目录 - 空目录",
        "description": "目标路径下没有子目录时返回空数组",
        "steps": [
          "准备一个空目录",
          "调用 detectSubDirectories(basePath)"
        ],
        "expected": "返回空数组 []"
      },
      {
        "title": "检测子目录 - 只有文件无目录",
        "description": "目标路径下只有文件没有子目录时返回空数组",
        "steps": [
          "准备一个目录，只包含文件: file1.ts, file2.ts",
          "调用 detectSubDirectories(basePath)"
        ],
        "expected": "返回空数组 []"
      }
    ],
    "passes": false
  },
  {
    "category": "functional",
    "prd": "2026-02-06-task-explore-parallel-design.md#2-目录自动拆分",
    "description": "路径提取函数 - 从 prompt 中提取目标路径",
    "bdd": [
      {
        "title": "路径提取 - 中文关键词匹配",
        "description": "匹配中文关键词后的路径",
        "steps": [
          "输入 prompt: '分析 src/ 目录下的代码'",
          "调用 extractTargetPath(prompt)"
        ],
        "expected": "返回 'src'"
      },
      {
        "title": "路径提取 - 英文关键词匹配",
        "description": "匹配英文关键词后的路径",
        "steps": [
          "输入 prompt: 'analyze code in packages/'",
          "调用 extractTargetPath(prompt)"
        ],
        "expected": "返回 'packages'"
      },
      {
        "title": "路径提取 - 去除引号",
        "description": "自动去除路径周围的引号",
        "steps": [
          "输入 prompt: '探索 \"src/tools\" 目录'",
          "调用 extractTargetPath(prompt)"
        ],
        "expected": "返回 'src/tools'（不含引号）"
      },
      {
        "title": "路径提取 - 路径不存在",
        "description": "提取的路径不存在时返回 null",
        "steps": [
          "输入 prompt: '分析 nonexistent/ 目录'",
          "文件系统中不存在 nonexistent/ 目录",
          "调用 extractTargetPath(prompt)"
        ],
        "expected": "返回 null"
      },
      {
        "title": "路径提取 - 无匹配时使用默认值",
        "description": "无法从 prompt 中提取路径时，默认返回 src",
        "steps": [
          "输入 prompt: '帮我看看代码有什么问题'",
          "文件系统中存在 src/ 目录",
          "调用 extractTargetPath(prompt)"
        ],
        "expected": "返回 'src'"
      },
      {
        "title": "路径提取 - 无匹配且无默认目录",
        "description": "无法匹配且 src 目录不存在时返回 null",
        "steps": [
          "输入 prompt: '帮我看看代码'",
          "文件系统中不存在 src/ 目录",
          "调用 extractTargetPath(prompt)"
        ],
        "expected": "返回 null"
      }
    ],
    "passes": false
  },
  {
    "category": "functional",
    "prd": "2026-02-06-task-explore-parallel-design.md#2-目录自动拆分",
    "description": "任务拆分函数 - 将单个 explore 任务拆分为多个并行任务",
    "bdd": [
      {
        "title": "任务拆分 - 正常拆分",
        "description": "目标目录有多个子目录时，拆分为多个任务",
        "steps": [
          "输入 params: { prompt: '分析 src/ 代码', description: '代码分析' }",
          "src/ 下有 3 个子目录: agent/, cli/, tools/",
          "调用 splitExploreTask(params)"
        ],
        "expected": "返回 3 个 TaskCommandParams，每个的 prompt 包含 '重点分析目录: src/xxx'，description 为 '代码分析: xxx'"
      },
      {
        "title": "任务拆分 - 单个子目录不拆分",
        "description": "只有一个子目录时不拆分，返回原始任务",
        "steps": [
          "输入 params: { prompt: '分析 lib/ 代码' }",
          "lib/ 下只有 1 个子目录: utils/",
          "调用 splitExploreTask(params)"
        ],
        "expected": "返回包含原始 params 的数组，长度为 1"
      },
      {
        "title": "任务拆分 - 无子目录不拆分",
        "description": "没有子目录时不拆分，返回原始任务",
        "steps": [
          "输入 params: { prompt: '分析 src/ 代码' }",
          "src/ 下没有子目录",
          "调用 splitExploreTask(params)"
        ],
        "expected": "返回包含原始 params 的数组，长度为 1"
      },
      {
        "title": "任务拆分 - 路径提取失败回退",
        "description": "无法提取路径且 src 不存在时，不拆分",
        "steps": [
          "输入 params: { prompt: '看看代码' }",
          "无法提取路径，且 src/ 目录不存在",
          "调用 splitExploreTask(params)"
        ],
        "expected": "返回包含原始 params 的数组，长度为 1"
      }
    ],
    "passes": false
  },
  {
    "category": "functional",
    "prd": "2026-02-06-task-explore-parallel-design.md#2-目录自动拆分",
    "description": "并行执行与结果合并 - execute 方法处理 explore 类型任务",
    "bdd": [
      {
        "title": "并行执行 - 全部成功",
        "description": "所有拆分任务执行成功时，合并结果返回",
        "steps": [
          "执行 task:explore 命令，拆分为 3 个任务",
          "3 个任务全部执行成功，分别返回 'result1', 'result2', 'result3'"
        ],
        "expected": "stdout = 'result1\\n\\n---\\n\\nresult2\\n\\n---\\n\\nresult3', stderr = '', exitCode = 0"
      },
      {
        "title": "并行执行 - 部分失败",
        "description": "部分任务失败时，返回成功结果和错误信息",
        "steps": [
          "执行 task:explore 命令，拆分为 3 个任务",
          "任务 1、3 成功返回 'result1', 'result3'",
          "任务 2 失败，错误信息 'Task 2 failed'"
        ],
        "expected": "stdout 包含 'result1' 和 'result3', stderr = 'Task 2 failed', exitCode = 1"
      },
      {
        "title": "并行执行 - 全部失败",
        "description": "所有任务失败时，返回所有错误信息",
        "steps": [
          "执行 task:explore 命令，拆分为 2 个任务",
          "2 个任务全部失败"
        ],
        "expected": "stdout = '', stderr 包含所有错误信息, exitCode = 1"
      },
      {
        "title": "并行执行 - 非 explore 类型不拆分",
        "description": "非 explore 类型任务保持原有逻辑",
        "steps": [
          "执行 task:general 命令"
        ],
        "expected": "不进行拆分，直接执行原有逻辑"
      }
    ],
    "passes": false
  },
  {
    "category": "functional",
    "prd": "2026-02-06-task-explore-parallel-design.md#1-命令截断渲染",
    "description": "命令截断函数 - 截断过长的命令字符串",
    "bdd": [
      {
        "title": "截断 - 短命令不截断",
        "description": "命令长度小于等于 maxLength 时，完整返回",
        "steps": [
          "输入 command = 'task:explore --prompt \"short\"' (30 字符)",
          "maxLength = 80",
          "调用 truncateCommand(command, maxLength)"
        ],
        "expected": "返回原始字符串 'task:explore --prompt \"short\"'"
      },
      {
        "title": "截断 - 长命令截断",
        "description": "命令长度超过 maxLength 时，截断并添加 ...",
        "steps": [
          "输入 command = 100 字符的字符串",
          "maxLength = 80",
          "调用 truncateCommand(command, maxLength)"
        ],
        "expected": "返回 77 字符 + '...'，总长度 80"
      },
      {
        "title": "截断 - 边界值等于 maxLength",
        "description": "命令长度正好等于 maxLength 时，不截断",
        "steps": [
          "输入 command = 80 字符的字符串",
          "maxLength = 80",
          "调用 truncateCommand(command, maxLength)"
        ],
        "expected": "返回原始 80 字符字符串，不添加 ..."
      },
      {
        "title": "截断 - 环境变量配置",
        "description": "通过环境变量自定义截断长度",
        "steps": [
          "设置 SYNAPSE_MAX_COMMAND_DISPLAY_LENGTH = 60",
          "输入 command = 80 字符的字符串",
          "调用 buildToolLine"
        ],
        "expected": "命令被截断为 57 字符 + '...'"
      }
    ],
    "passes": false
  },
  {
    "category": "functional",
    "prd": "2026-02-06-task-explore-parallel-design.md#1-命令截断渲染",
    "description": "终端渲染集成 - buildToolLine 使用截断后的命令",
    "bdd": [
      {
        "title": "渲染集成 - 截断命令显示",
        "description": "buildToolLine 方法使用截断后的命令构建输出行",
        "steps": [
          "调用 buildToolLine({ depth: 0, isLast: false, dotColor: gray, command: 100字符命令 })",
          "MAX_COMMAND_DISPLAY_LENGTH = 80"
        ],
        "expected": "返回格式为 '• Bash(截断后命令...)'，命令部分最多 80 字符"
      },
      {
        "title": "渲染集成 - 短命令完整显示",
        "description": "短命令不被截断",
        "steps": [
          "调用 buildToolLine({ depth: 0, isLast: false, dotColor: gray, command: 'ls -la' })"
        ],
        "expected": "返回 '• Bash(ls -la)'，命令完整显示"
      }
    ],
    "passes": false
  }
]
